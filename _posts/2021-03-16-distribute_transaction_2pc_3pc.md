---
layout: post
date: 2021-03-16 15:32:32 +0800
categories: 转载 分布式事务
title: "分布式事务:两阶段提交与三阶段提交"
mermaid: on
---
<!--
mermaid example:
<div class="mermaid"
    mermaid program
</div>
-->

[转载](https://segmentfault.com/a/1190000012534071)

在分布式系统中著有 CAP 理论，该理论由加州大学伯克利分校的 [Eric Brewer](https://en.wikipedia.org/wiki/Eric_Brewer_(scientist)) 教授提出，阐述了在一个分布式系统中不可能同时满足一致性（ **C** onsistency）、可用性（ **A** vailability），以及分区容错性（ **P** artition Tolerance）。

- **一致性：** 在分布式系统中数据往往存在多个副本，一致性描述的是这些副本中的数据在内容和组织上的一致。
- **可用性：** 描述系统对用户的服务能力，所谓可用是指在用户能够容忍的时间范围内返回用户期望的结果。
- **分区容错性：** 分布式系统通常由多个节点构成，由于网络是不可靠的，所以存在分布式集群中的节点因为网络通信故障导致被孤立成一个个小集群的可能性，即网络分区，分区容错性要求在出现网络分区时系统仍然能够对外提供一致性的可用服务。

对于一个分布式系统而言，我们要始终假设网络是不可靠的，因此分区容错性是对一个分布式系统最基本的要求，我们的切入点更多的是尝试在可用性和一致性之间寻找一个平衡点，但这也并非要求我们在系统设计时一直建立在网络出现分区的前提之上，然后对一致性和可用性在选择时非此即彼。

Eric Brewer 教授在 2012 年就曾指出 **CAP 理论证明不能同时满足一致性、可用性，以及分区容错性的观点在实际系统设计指导上存在一定的误导性。** 传统对于 CAP 理论的理解认为在设计分布式系统时必须满足 P，然后在 C 和 A 之间进行取舍，这是片面的。实际中网络出现分区的可能性还是比较小的，尤其是目前网络环境正在变得越来越好，甚至许多系统都拥有专线支撑，所以在网络未出现分区时，还是应该兼顾 A 和 C。另外就是对于一致性、可用性，以及分区容错性三者在度量上也应该有一个评定范围，最简单的以可用性来说，当有多少占比请求出现响应超时才可以被认为是不满足可用性，而不是一出现超时就认为是不可用的。最后我们需要考虑的一点就是分布式系统一般都是一个比较大且复杂的系统，我们应该从更小的粒度上对各个子系统进行评估和设计，而不是简单的从整体上武断决策。

让分布式集群始终对外提供可用的一致性服务一直是富有挑战和趣味的任务。暂且抛开可用性，拿一致性来说，对于关系型数据库我们通常利用事务来保证数据的强一致性，但是当我们的数据量越来越大，大到单库已经无法承担时，我们不得不采取分库分表的策略对数据库实现水平拆分，或者引入 NoSQL 技术，构建分布式数据库集群以分摊读写压力，从而提升数据库的存储和响应能力，但是多个数据库实例也为我们使用数据库带来了许多的限制，比如主键的全局唯一、联表查询、数据聚合等等，另外一个相当棘手的问题就是数据库的事务由原先的单库事务变成了现在的分布式事务。

分布式事务的实现并不是无解的，比如下文要展开的两阶段提交（2PC：Two-Phase Commit）和三阶段提交（3PC：Three-Phase Commit）都给我们提供了思路，但是在分布式环境下如何保证数据的强一致性，并对外提供高可用的服务还是相当棘手的，因此很多分布式系统对于数据强一致性都敬而远之。

## 两阶段提交协议(2PC: Two-Phase Commit )

两阶段提交协议的目标是在于为分布式系统保证数据的一致性，许多分布式协议采用该协议提供对分布式事务的支持。顾名思义，该协议将一个分布式的事务过程拆分为两个阶段：**投票**和**事务提交**。为了让整个数据库集群能够正常运营，改协议指定了一个**协调者**单点，用于协调整个数据库集群各节点的运行。为了简化描述，我们将数据库集群中的各个节点称为参与者，三阶段提交协议中同样包含协调者和参与者这两个角色定义。

### 第一阶段：投票

该阶段的主要目的是在于打探数据库集群中的各个参与者是否能够正常执行事务，具体步骤如下：

1. 协调者向所有的参与者发送事务执行请求，并等待参与者反馈事务执行结果
2. 事务参与者收到请求后，执行事务但是不提交，并记录事务日志
3. 参与者将自己事务执行情况反馈给协调者，同时阻塞等待协调者的后续指令

#### 第二阶段：事务提交

经过第一阶段的协调者询问之后，各个参与者回复自己事务的执行情况，存在三种可能：

1. 所有参与者都回复能正常执行事务
2. 一个或者多个参与者回复事务执行失败
3. 协调者等待超时

对于第一种情况，协调者向所有参与者发出提交事务的通知，具体步骤如下：

<div class="mermaid">
sequenceDiagram
  participant 协调者
  participant 参与者集群
  协调者 -> 参与者集群: 1. 询问各参与者事务是否可以正常执行
  activate 参与者集群
  参与者集群 -> 参与者集群: 1.1 执行事务，但不提交
  参与者集群 -> 协调者: 1.2 所有参与者均能成功执行事务
  deactivate 参与者集群
  activate 参与者集群
  协调者 -> 参与者集群: 2. 向所有参与者发起事务提交通知
  参与者集群 -> 参与者集群: 2.1 提交事务，并释放资源
  参与者集群 -> 协调者: 2.2 反馈事务提交结果
  deactivate 参与者集群
</div>



## 三阶段提交协议(3PC: Three-Phase Commit)



