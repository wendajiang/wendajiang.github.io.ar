<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>coroutine learn | 「靡不有初，鲜克有终」</title><meta content="blog of david" name=description><link href=https://wendajiang.github.io/coroutine-learn/ rel=canonical><meta content="coroutine learn" property=og:title><meta content="blog of david" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/coroutine-learn/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta content=2023-06-12T12:29:41 property=og:updated_time><meta content="coroutine learn" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/coroutine-learn/"
      },
      "headline": "coroutine learn",
      "image": ,
      "datePublished": "2023-06-12T12:29:41",
      "dateModified": "2023-06-12T12:29:41",
      "author": {
        "@type": "Organization",
        "name": "coroutine learn"
      },
      "publisher": {
        "@type": "Organization",
        "name": "coroutine learn",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "blog of david"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Coroutine Learn",
            "item": "https://wendajiang.github.io/coroutine-learn/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/coroutine-learn/#coroutine-theory>Coroutine Theory</a></li><ul><li><a href=https://wendajiang.github.io/coroutine-learn/#coroutines-are-functions-are-coroutines>Coroutines are Functions are Coroutines</a></li><ul><li><a href=https://wendajiang.github.io/coroutine-learn/#normal-functions>"Normal" Functions</a> <ul><li><a href=https://wendajiang.github.io/coroutine-learn/#the-call-operation>The 'Call' operation</a><li><a href=https://wendajiang.github.io/coroutine-learn/#the-return-operation>The 'Return' operation</a></ul></ul><li><a href=https://wendajiang.github.io/coroutine-learn/#coroutines>Coroutines</a></li><ul><li><a href=https://wendajiang.github.io/coroutine-learn/#coroutine-activation-frames>Coroutine activation frames</a></ul></ul><li><a href=https://wendajiang.github.io/coroutine-learn/#reference>reference</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>coroutine learn</h1><p><small>Posted 2023-06-12 12:29:41 ‐ <strong>5 min read</strong></small><p><div class=category-area>「 <a href=https://wendajiang.github.io/tags/cpp> <div class=category>cpp</div> </a><a href=https://wendajiang.github.io/tags/coroutine> <div class=category>coroutine</div> </a> 」</div></div><p>https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2464r0.html 反对 asio 进入标准<h1 id=coroutine-theory><a aria-label="Anchor link for: coroutine-theory" class=zola-anchor href=#coroutine-theory>Coroutine Theory</a></h1><h2 id=coroutines-are-functions-are-coroutines><a aria-label="Anchor link for: coroutines-are-functions-are-coroutines" class=zola-anchor href=#coroutines-are-functions-are-coroutines>Coroutines are Functions are Coroutines</a></h2><p>A coroutine is a generalisation of a function that allows the function to be suspended and then later resumed.<h3 id=normal-functions><a aria-label="Anchor link for: normal-functions" class=zola-anchor href=#normal-functions>"Normal" Functions</a></h3><p>A normal function can be thought of as having two operations: <strong>Call</strong> and <strong>Return</strong>(note that I'm lumping "throwing an exception" here broadly under the Return operation)<p>The <strong>Call</strong> operation creates an activation frame, suspends execution of the calling function and transfers execution to the start of the function being called.<p>The <strong>Return</strong> operation passes the return-value to the caller, destroys the activation frame and then resumes execution of the caller just after the point at which it called the function.<blockquote><p>Activation Frames The block of memory that holds the current state of a particular invocation of a function. This state includes the values of any parameters that were passed to it and the values of any local variables.<p>For "normal" functions, the activation frame also includes the return-address. You can think of these pieces of information together as describing the 'continuation' of the function-call. ie. they describe which invocation of which function should continue executing at which point when this function completes.<p>With "normal" functions, all activation frames have strictly nested lifetimes. This strict nesting allows use of a highly efficient memory allocation data-structure for allocating and freeing the activation frames for each of the function calls. This data-structure is commonly refered to as "the stack".</blockquote><h4 id=the-call-operation><a aria-label="Anchor link for: the-call-operation" class=zola-anchor href=#the-call-operation>The 'Call' operation</a></h4><p>When a funtion calls another function, the caller must first prepare itself for suspension.<h4 id=the-return-operation><a aria-label="Anchor link for: the-return-operation" class=zola-anchor href=#the-return-operation>The 'Return' operation</a></h4><p>When a function returns via <code>return</code>-stmt, the function first stores the return value (if any) where the caller can access it. This could either be in the caller's activation frame or the function's activation frame.<p>Then the function destorys the activation frame by:<ul><li>destroying any local variables in-scope at the return-point<li>destroying any parameter objects<li>freeing memory used by the activation-frame</ul><p>And finally, it resumes execution of the caller by:<ul><li>restoring the activation frame of the caller by setting the stack register to point to the activation frame of the caller and restoring any registers that might have been clobbered by the function.<li>jumping to the resume-point of the caller that was stored during the 'Call' operation.</ul><h2 id=coroutines><a aria-label="Anchor link for: coroutines" class=zola-anchor href=#coroutines>Coroutines</a></h2><p>Coroutines generalise the operations of a function by separating out some of the steps performed in the Call and Return operations into three extra operations: <strong>Suspend, Resume, Destroy</strong>.<p>The <strong>Suspend</strong> operation suspends execution of the coroutine at the current point within the function and transfers execution back to the caller or resumer without destroying the activation frame. Any Objects in-scope at the point of suspension remain alive after the coroutine execution is suspended.<p>Note that, like the <strong>Return</strong> operation of a function, a coroutine can only be suspended from within the coroutine itself at well-defined suspend-points.(<code>co_await, co_yield</code>)<p>The <strong>Resume</strong> operation resumes execution of a suspended coroutine at the point at which is was suspended. This reactivates the coroutine's activation frame.<p>The <strong>Destroy</strong> operation destroys the activation frame without resuming execution of the coroutine. Any objects that were in-scope at the suspend point will be destroyed. Memory used to store the activation frame is freed.<h3 id=coroutine-activation-frames><a aria-label="Anchor link for: coroutine-activation-frames" class=zola-anchor href=#coroutine-activation-frames>Coroutine activation frames</a></h3><p>Since coroutines can be suspended without destroying the activation frame, we can no longer guarantee that activation frame frame lifetimes will be stricted nested. This means that activation frames cannot in general be allocated using a stack data-structure and so may need to be stored on the heap instead.<p>There are some provisions in the C++ Coroutines TS to allow the memory for the coroutine frame to be allocated from the activation frame of the caller if the compiler can prove that the lifetime of the coroutine is indeed strictly nested within the lifetime of the caller. This can avoid heap allocations in many case provided you have a sufficiently smart pointer.<p>With coroutins there are some parts of the activation frame that need to be preserved across coroutine suspension and there are some parts that only need to be kept around while the coroutine is executing. For example, the lifetime of a variable with scope that does not span any coroutine suspend-points can potentially be stored on the stack.<p>You can logically think of the activation frame of a corouine as being comprised of two parts: the <strong>coroutine fame</strong> and the <strong>stack frame</strong>.<p>The 'coroutine frame' holds part of the coroutine's activation frame that <strong>persists</strong> while the coroutine if suspended and the 'stack frame' part only exists while the coroutine is executing and is freed when the coroutine suspends and transfers execution back to the caller/resumer.<h1 id=reference><a aria-label="Anchor link for: reference" class=zola-anchor href=#reference>reference</a></h1><ul><li>https://devblogs.microsoft.com/oldnewthing/20210504-01/?p=105178<li>https://lewissbaker.github.io/</ul></article></div></div></div><div id=gitalk-container></div><link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gitalk=new Gitalk({id:'coroutine learn',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script></div><script defer src=https://wendajiang.github.io/js/main.js></script><script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script><script defer src=https://wendajiang.github.io/search_index.en.js></script><script defer src=https://wendajiang.github.io/js/search.js></script>