<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>cusomization point object | 「靡不有初，鲜克有终」</title><meta content="blog of david" name=description><link href=https://wendajiang.github.io/customization-point-object/ rel=canonical><meta content="cusomization point object" property=og:title><meta content="blog of david" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/customization-point-object/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta content=2023-12-21T14:54:34 property=og:updated_time><meta content="cusomization point object" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/customization-point-object/"
      },
      "headline": "cusomization point object",
      "image": ,
      "datePublished": "2023-12-21T14:54:34",
      "dateModified": "2023-12-21T14:54:34",
      "author": {
        "@type": "Organization",
        "name": "cusomization point object"
      },
      "publisher": {
        "@type": "Organization",
        "name": "cusomization point object",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "blog of david"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Customization Point Object",
            "item": "https://wendajiang.github.io/customization-point-object/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/customization-point-object/#adl>ADL</a></li><ul><li><a href=https://wendajiang.github.io/customization-point-object/#name-lookup>Name lookup</a></li><ul><li><a href=https://wendajiang.github.io/customization-point-object/#types-of-lookup>Types of lookup</a> <ul><li><a href=https://wendajiang.github.io/customization-point-object/#qualified-name-lookup>Qualified name lookup</a><li><a href=https://wendajiang.github.io/customization-point-object/#unqualified-name-lookup>Unqualified name lookup</a></ul></ul></ul><li><a href=https://wendajiang.github.io/customization-point-object/#cpo>CPO</a></li><ul><li><a href=https://wendajiang.github.io/customization-point-object/#niebloid>Niebloid</a></ul><li><a href=https://wendajiang.github.io/customization-point-object/#tag-invoke-model>tag_invoke model</a><li><a href=https://wendajiang.github.io/customization-point-object/#reference>reference</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>cusomization point object</h1><p><small>Posted 2023-12-21 14:54:34 ‐ <strong>6 min read</strong></small><p></div><p>Derivation:<p>When imitate format code liking fmt library for SystemVerilog $display, using gcc9.2.0 compile the code, throw compile error, the ambiguous error the <code>to_string_view</code> which in fmt namespace and svfmt namespace.<p>So to fix this, I search the result of ADL mechanism.<h1 id=adl><a aria-label="Anchor link for: adl" class=zola-anchor href=#adl>ADL</a></h1><p>First, we should introduce the principle of ADL. Argument-dependent lookup, also known as ADL, or Koenig lookup, is the set of rules for looking up the unqualified function names in function-call expressions, including implicit function calls to overloaded operators. These function names are looked up in the namespaces of their arguments in addition to the scopes and namespaces considered by the usual unqualified name lookup.<p>ADL makes it possible to use operators defined in a different namespace. Example:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>#include </span><span style=color:#f1fa8c>&LTiostream>
</span><span style=font-style:italic;color:#8be9fd>int </span><span style=color:#50fa7b>main</span><span>() </span><span style=color:#fff>{
</span><span>  std</span><span style=color:#ff79c6>::</span><span>cout </span><span style=color:#ff79c6><< </span><span style=color:#f1fa8c>"Test</span><span style=color:#ff79c6>\n</span><span style=color:#f1fa8c>"</span><span>; </span><span style=color:#6272a4>// There is no operator<< in global namespace, but ADL examines std namespace because the left argument is in std and finds std::operator<<(std::ostream&, const char*)
</span><span>  </span><span style=color:#ff79c6>operator<<</span><span>(std</span><span style=color:#ff79c6>::</span><span>cout, </span><span style=color:#f1fa8c>"Test</span><span style=color:#ff79c6>\n</span><span style=color:#f1fa8c>"</span><span>); </span><span style=color:#6272a4>// Same, using function call notation.
</span><span>
</span><span>  std</span><span style=color:#ff79c6>::</span><span>cout </span><span style=color:#ff79c6><<</span><span> endl; </span><span style=color:#6272a4>// Error: 'endl' is not declared in this namespace. This is not a function call to endl(), so ADL does not apply
</span><span>  </span><span style=color:#50fa7b>endl</span><span>(std</span><span style=color:#ff79c6>::</span><span>cout); </span><span style=color:#6272a4>// Ok: This is a function call: ADL examines std namespace because the argument of endl is in std, and finds std::endl
</span><span>
</span><span>  (endl)(std</span><span style=color:#ff79c6>::</span><span>cout); </span><span style=color:#6272a4>// Error: 'endl' is not declared in this namespace. The sub-expression (endl) is not an unqualified-id
</span><span style=color:#fff>}
</span></code></pre><p>Another example:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>using</span><span> std</span><span style=color:#ff79c6>::</span><span>swap;
</span><span style=color:#50fa7b>swap</span><span>(a, b); </span><span style=color:#6272a4>// not std::swap(a, b); as if this namespace define the swap, first using this namespace swap, not std::swap.
</span></code></pre><p>More detailed rules, please see <a href=https://en.cppreference.com/w/cpp/language/adl>cpp-reference</a>.<h2 id=name-lookup><a aria-label="Anchor link for: name-lookup" class=zola-anchor href=#name-lookup>Name lookup</a></h2><p><a href=https://en.cppreference.com/w/cpp/language/lookup>src</a><p>For example, to compile <code>std::cout << std::endl;</code>, the compiler performs:<ul><li>unqualified name lookup for the name std, which finds the declaration of namespace std in the header <code>&LTiostream></code><li>qualified name lookup for the name cout, which finds a variable declaration in the namespace std<li>qualified name lookup for the name endl, which finds a function template declaration in the namespace std<li>both argument-dependent lookup for the name operator<<, which finds multiple function template declarations in the namespace std, and qualified name lookup for the name <code>std::ostream::operator<<</code>, which find multiple member function declarations in class <code>std::ostream</code></ul><p>For function and function template names, name lookup can associate multiple declarations with the same name, and may obtain additional declarations from ADL. Template argument deduction may also apply, and the set of declarations is passed to overload resolution, which selects the declaration that will be used. Member access rules, if applicable, are considered only after name lookup and overload resolution.<p>For all other names (variables, namespaces, classed, etc), name lookup can associate multiple declarations only if they declare the same entity, otherwise it must produce a single declaration in order for the program to compile. Lookup for a name in a scope finds all declarations of that name, with one exception, known as the "struct hack" or "type/non-type hiding": Within the same scope, some occurrences of a name may refer to a declaration of a class/struct/union/enum that is not a typedef, while all other occurrences of the same name either all refer to the same variable, non-static data member, or enumerator, or they all refer to possibly overloaded function or function template names. In this case, there is no error, but the type name is hidden from lookup.<h3 id=types-of-lookup><a aria-label="Anchor link for: types-of-lookup" class=zola-anchor href=#types-of-lookup>Types of lookup</a></h3><p>If the name appears immediately to the right of the scope resolution operator:: or possibly after :: followed by the disambiguating keyword template, see<h4 id=qualified-name-lookup><a aria-label="Anchor link for: qualified-name-lookup" class=zola-anchor href=#qualified-name-lookup>Qualified name lookup</a></h4><p>A qualified name may refer to a<ul><li>class member (include static / non-static functions, types, templates, etc).<li>namespace member (including another namespace)<li>enumerator</ul><p>Otherwise, see<h4 id=unqualified-name-lookup><a aria-label="Anchor link for: unqualified-name-lookup" class=zola-anchor href=#unqualified-name-lookup>Unqualified name lookup</a></h4><ul><li>which, for function names, includes Argument-dependent lookup</ul><h1 id=cpo><a aria-label="Anchor link for: cpo" class=zola-anchor href=#cpo>CPO</a></h1><p>c++20 ranges library import CPO, using function object not function to inhibit ADL.<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>using</span><span> std</span><span style=color:#ff79c6>::</span><span>vector;
</span><span style=color:#ff79c6>using namespace</span><span> std</span><span style=color:#ff79c6>::</span><span>ranges;
</span><span>
</span><span>vector<</span><span style=font-style:italic;color:#8be9fd>int</span><span>> a;
</span><span style=color:#50fa7b>find</span><span>(a</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>begin</span><span>(), a</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>end</span><span>(), </span><span style=color:#bd93f9>2</span><span>);
</span><span style=color:#6272a4>// should call std::ranges::find
</span></code></pre><ul><li><code>vector</code> in namespace <code>std</code>, so ADL would find the <code>std::find</code><li><code>std::find</code> need <code>begin/end</code> have the same type, so <code>std::find</code> is more specific to <code>std::ranges::find</code> and <code>std::ranges::find</code> has Concepts, but specific is more high priority to the concepts.</ul><p>If <code>std::ranges::find</code> is function, above code would call <code>std::find</code>. So <code>std::ranges::find</code> is function object.<p>But if we just don't want to call it an object. We want call it a function. It became a <strong>niebloid</strong>.<h2 id=niebloid><a aria-label="Anchor link for: niebloid" class=zola-anchor href=#niebloid>Niebloid</a></h2><p>It's possible tha a future language feature might come around that would allow us to explicity opt functions and functions templates out of ADL. This would allow an implementation strategy like:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>namespace </span><span>ranges </span><span style=color:#fff>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>template</span><span>&LTintput_iterator I, sentinel_for&LTT> S, weakly_incrementable O>
</span><span>    requires indirectly_copyable&LTI, O>
</span><span>    no_adl constexpr copy_result&LTI, O> </span><span style=color:#50fa7b>copy</span><span>(I </span><span style=font-style:italic;color:#ffb86c>first</span><span>, S </span><span style=font-style:italic;color:#ffb86c>last</span><span>, O </span><span style=font-style:italic;color:#ffb86c>result</span><span>);
</span><span>
</span><span>  </span><span style=font-style:italic;color:#8be9fd>template</span><span>&LTinput_range R, weakly_incrementable O>
</span><span>    requires indirectly_copyable&LTiterator_t&LTR>, O>
</span><span>    no_adl constexpr copy_result&LTborrowed_iterator_t&LTR>, O> </span><span style=color:#50fa7b>copy</span><span>(R</span><span style=color:#ff79c6>&& </span><span style=font-style:italic;color:#ffb86c>r</span><span>, O </span><span style=font-style:italic;color:#ffb86c>result</span><span>);
</span><span style=color:#fff>}
</span></code></pre><p>For instance, Matt Calabrese's <a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1292r0.html>CPF</a> proposal would allow you to declare a function <code>final</code> to get this desired ADL-inhibiting behavior.<p>And the specification is written in a way to allow such future language evolution without having to change anything. Indeed, it is within the implementation purview today for GCC to do something like add a <code>__gcc_no_adl</code> specifier that itself magically inhibits ADL and ends up with <code>std::ranges::copy</code> not being an object(although they do not do that today). Which means that while:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=font-style:italic;color:#8be9fd>auto</span><span> f </span><span style=color:#ff79c6>=</span><span> std</span><span style=color:#ff79c6>::</span><span>ranges</span><span style=color:#ff79c6>::</span><span>begin;
</span></code></pre><p>is specified to be valid code, the same is not true for:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=font-style:italic;color:#8be9fd>auto</span><span> g </span><span style=color:#ff79c6>=</span><span> std</span><span style=color:#ff79c6>::</span><span>ranges</span><span style=color:#ff79c6>::</span><span>copy;
</span></code></pre><h1 id=tag-invoke-model><a aria-label="Anchor link for: tag-invoke-model" class=zola-anchor href=#tag-invoke-model><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1895r0.pdf>tag_invoke model</a></a></h1><h1 id=reference><a aria-label="Anchor link for: reference" class=zola-anchor href=#reference>reference</a></h1><ul><li><a href=https://en.cppreference.com/w/cpp/ranges/cpo>cpp reference</a><li><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1895r0.pdf>tag invoke and cpo</a><li>重点：<a href=https://brevzin.github.io/c++/2020/12/19/cpo-niebloid/>blog: cpo biebloid</a><li><a href=https://mysteriouspreserve.com/blog/2023/04/18/Cpp-CPO-and-Niebloids/>chinese blog: cpo and biebloid</a><li><a href=https://en.cppreference.com/w/cpp/language/adl>ADL(argument-dependent lookup)</a><li><a href=https://zhuanlan.zhihu.com/p/532859426>C++特殊定制</a><li><a href=https://brevzin.github.io/c++/2020/12/01/tag-invoke/>why tag_invoke is not the solution I want</a><li><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1292r0.html>CPF: proposal replacement of the ADL</a><li><a href=http://ericniebler.com/2014/10/21/customization-point-design-in-c11-and-beyond/>Customization Point Design in C++11 and Beyond</a><li><a href=https://stackoverflow.com/questions/8111677/what-is-argument-dependent-lookup-aka-adl-or-koenig-lookup>what is ADL</a></ul></article></div></div></div><div id=gitalk-container></div><link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gitalk=new Gitalk({id:'cusomization point object',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script></div><script defer src=https://wendajiang.github.io/js/main.js></script><script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script><script defer src=https://wendajiang.github.io/search_index.en.js></script><script defer src=https://wendajiang.github.io/js/search.js></script>