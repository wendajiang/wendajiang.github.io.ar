<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Error modle and handle | 「靡不有初，鲜克有终」</title><meta content="error model and handle thinking from boost.outcome" name=description><link href=https://wendajiang.github.io/error-model-or-handle/ rel=canonical><meta content="Error modle and handle" property=og:title><meta content="error model and handle thinking from boost.outcome" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/error-model-or-handle/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta content=2023-07-19T16:22:51 property=og:updated_time><meta content="Error modle and handle" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/error-model-or-handle/"
      },
      "headline": "Error modle and handle",
      "image": ,
      "datePublished": "2023-07-19T16:21:51",
      "dateModified": "2023-07-19T16:22:51",
      "author": {
        "@type": "Organization",
        "name": "Error modle and handle"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Error modle and handle",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "error model and handle thinking from boost.outcome"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Error Model Or Handle",
            "item": "https://wendajiang.github.io/error-model-or-handle/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#the-origin>The origin</a></li><ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#summary>summary</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#error-codes>Error Codes</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#exception>Exception</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#recap>recap</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#bugs-aren-t-recoverable-errors>Bugs aren't recoverable errors</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#reliabiliry-fault-tolerance-and-isolation>Reliabiliry, Fault-Tolerance, and Isolation</a></li><ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#to-build-a-reliable-system>To build a reliable system</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#abandonment>Abandonment</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#recoverable-errors-type-directed-exceptions>Recoverable errors: type-directed exceptions</a></ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#restrospective-and-conslusion>Restrospective and conslusion</a></ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#boost-outcome-std-expected-and-boost-leaf>Boost.outcome , std::expected, and boost.leaf</a></li><ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#rust-error-handling>Rust error handling</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#result-either-in-c>Result (Either) in C++</a><li><a href=https://wendajiang.github.io/error-model-or-handle/#leaf-comfortable-scenoria>Leaf comfortable scenoria</a></ul><li><a href=https://wendajiang.github.io/error-model-or-handle/#reference>reference</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>Error modle and handle</h1><p><small>Posted 2023-07-19 16:21:51 ‐ <strong>5 min read</strong></small><p><div class=category-area>「 <a href="https://wendajiang.github.io/tags/error model"> <div class=category>error model</div> </a><a href="https://wendajiang.github.io/tags/error handle"> <div class=category>error handle</div> </a><a href=https://wendajiang.github.io/tags/cpp> <div class=category>cpp</div> </a> 」</div></div><h1 id=the-origin><a aria-label="Anchor link for: the-origin" class=zola-anchor href=#the-origin>The origin</a></h1><p><strong>原文</strong> <a href=http://joeduffyblog.com/2016/02/07/the-error-model/>The Error Model</a> and <a href=https://zhuanlan.zhihu.com/p/55835404>知乎翻译</a><h2 id=summary><a aria-label="Anchor link for: summary" class=zola-anchor href=#summary>summary</a></h2><h2 id=error-codes><a aria-label="Anchor link for: error-codes" class=zola-anchor href=#error-codes>Error Codes</a></h2><pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=font-style:italic;color:#8be9fd>int</span><span> err </span><span style=color:#ff79c6>= </span><span style=color:#50fa7b>foo</span><span>();
</span><span style=color:#ff79c6>if </span><span>(err)  </span><span style=color:#6272a4>// error! deal with it
</span></code></pre><p>Many functional languages use return codes disguised in monads and names things like Option<t>, Maybe<t>, Error<t>, which, when coupled with ad dataflow-style of programming and pattern matching, feel far more natural. This approach removes several majar drawbacks to return codes that we're about to discuss, especially compared to C. Rust has largely adopted this model but has some exciting things with it for system programmers. <p>Dispite theis simplicity, return codes do some with some baggage; in summary:</p> <ul><li>performance can suffer (branch that compiler can't optimize)<li>Programming model usabiliry can be poor<li>The biggie: you can accidentally forget to check for errors (<strong>Rust guaratee by compiler</strong>)</ul> <p>上面文章也提到 Rust 在除了性能之外的方面已经做的很好 (pattern matching and try! macro)</p> <p>But we need fail-fast -> exception</p> <h2 id=exception><a aria-label="Anchor link for: exception" class=zola-anchor href=#exception>Exception</a></h2> <p><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2010/n3051.html>cpp deprecate exception specifications</a>, so <code>noexcept</code> is also bad. <a href=https://wendajiang.github.io/cpp-exception/>cpp exception</a></p> <h2 id=recap><a aria-label="Anchor link for: recap" class=zola-anchor href=#recap>recap</a></h2> <table><thead><tr><th><th>the good<th>the bad<th>the ugly<tbody><tr><td>Error Code<td>1. All function that can fail are explicit annotated<br>2. All error handling at callsites is explicit<td>1. you can forget to check them<br>2. Performance of success paths suffers<td>usability is often subpar<tr><td>All Excpetions<td>first class language support<td>1. Performance is typically worse than it could be<br>2. handling is often done in a non-local manner, where less information about an error is known(goto-like)<td><tr><td>Unchecked Exceptions<td>conducive to rapid development where dealing with errors reliably isn't critical<td>Anything can fail without warning from the language<td>reliability is as bad as it gets<tr><td>Checked Exceptions<td>all function that can fail are explicitly annotated<td>1. callsites aren't explicit about can fail and error propagation<br>2. systems that let some subset of exceptions go unchecked poison the well(not all errors are explicit)<td>people hate them(in java, at least)</table> <p>Wouldn't it be great if we could take all of the Goods and leave out the Bads and The Uglies?</p> <h2 id=bugs-aren-t-recoverable-errors><a aria-label="Anchor link for: bugs-aren-t-recoverable-errors" class=zola-anchor href=#bugs-aren-t-recoverable-errors>Bugs aren't recoverable errors</a></h2> <ul><li>A recoverable error is usually the result of programmatic data validation.<li>A bug is a kind of error the programmer didn't expect.</ul> <blockquote><p>The wrong point: Exceptions and return codes are equally expressive, they should however not be used to describe errors. For example, the return codes contained definitions like ARRAY_INDEX_OUT_OF_RANGE. It cannot be handled or fixed at runtime, it can only be fixed by its developer. Thus there should be no according return code, but instead there should be assert.</blockquote> <h2 id=reliabiliry-fault-tolerance-and-isolation><a aria-label="Anchor link for: reliabiliry-fault-tolerance-and-isolation" class=zola-anchor href=#reliabiliry-fault-tolerance-and-isolation>Reliabiliry, Fault-Tolerance, and Isolation</a></h2> <h3 id=to-build-a-reliable-system><a aria-label="Anchor link for: to-build-a-reliable-system" class=zola-anchor href=#to-build-a-reliable-system>To build a reliable system</a></h3> <p>As with most distributed systems, our architecture assumed process failure was inevitable. We went to great length to defend aginst cascading failures, journal regularly, and to enable restartability of programs and services.</p> <h3 id=abandonment><a aria-label="Anchor link for: abandonment" class=zola-anchor href=#abandonment>Abandonment</a></h3> <p>Perhaps the most important technique is regularly journaling and checkpointing precious persistent state. Jim Gray’s 1985 paper, <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.110.9127&rep=rep1&type=pdf">Why Do Computers Stop and What Can Be Done About It?</a>, describes this concept nicely.</p> <h3 id=recoverable-errors-type-directed-exceptions><a aria-label="Anchor link for: recoverable-errors-type-directed-exceptions" class=zola-anchor href=#recoverable-errors-type-directed-exceptions>Recoverable errors: type-directed exceptions</a></h3> <p>For example, file I/O, network I/O, parsing data, validating user data.</p> <p>The exception has good performance on the good path, it's zero-cost.</p> <h2 id=restrospective-and-conslusion><a aria-label="Anchor link for: restrospective-and-conslusion" class=zola-anchor href=#restrospective-and-conslusion>Restrospective and conslusion</a></h2> <p>The final model in the article featured:</p> <ul><li>An architecture that assumed fine-grained isolation and recoverability from failure.<li>Distinguishing between bugs and recoverable errors.<li>Assertions, abandonment for all bugs</ul> <hr> <p>So next, we should look at the C++ system. And if we do not use exception, how to introduce the Rust smell code into C++.</p> <h1 id=boost-outcome-std-expected-and-boost-leaf><a aria-label="Anchor link for: boost-outcome-std-expected-and-boost-leaf" class=zola-anchor href=#boost-outcome-std-expected-and-boost-leaf>Boost.outcome , std::expected, and boost.leaf</a></h1> <p><code>Boost.outcome.result</code> is more like <code>std::variant</code>, and <code>std::expected(C++23)</code> is more like <code>std::optional</code> extension. The detail in reference [how std::expected interacts with boost.outcome].Dissimilarities section.</p> <h2 id=rust-error-handling><a aria-label="Anchor link for: rust-error-handling" class=zola-anchor href=#rust-error-handling>Rust error handling</a></h2> <p><a href=https://doc.rust-lang.org/book/ch09-02-recoverable-errors-with-result.html>rust book</a> show rust how to modle the error and handle it. Recommend <a href=https://doc.rust-lang.org/book/ch09-03-to-panic-or-not-to-panic.html#guidelines-for-error-handling>the guidelines for error handling</a></p> <ul><li>Unrecoverable error with panic! <ul><li><code>panic!</code> can record the backtrace</ul><li>Recoverable errors with Result <ul><li>pattern matching<li>Propagating error with <code>?</code></ul></ul> <h2 id=result-either-in-c><a aria-label="Anchor link for: result-either-in-c" class=zola-anchor href=#result-either-in-c>Result (Either) in C++</a></h2> <p>I personally like the Rust abstract, instead of error code, it propose the <code>Reulst&LTT, E></code>, and outcome.result can be used in c++.</p> <h2 id=leaf-comfortable-scenoria><a aria-label="Anchor link for: leaf-comfortable-scenoria" class=zola-anchor href=#leaf-comfortable-scenoria>Leaf comfortable scenoria</a></h2> <p>If you need an error handling framework which has predictable sad path overhead unlike C++ exceptions, but you otherwise want similar syntax and use experience to C++ exceptions, LEAF is a very solid choice. <del>Do not use in my ray-like project, i do not like the exception when should support API for application user.</del></p> <h1 id=reference><a aria-label="Anchor link for: reference" class=zola-anchor href=#reference>reference</a></h1> <ul><li>https://www.boost.org/doc/libs/develop/libs/outcome/doc/html/index.html <ul><li>https://www.boost.org/doc/libs/develop/libs/outcome/doc/html/reference/types/basic_result.html<li>https://www.boost.org/doc/libs/develop/libs/outcome/doc/html/alternatives/leaf.html<li>https://boostorg.github.io/leaf/#_reporting_errors</ul><li><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p0323r12.html#cool-story>std::expected proposal</a><li><a href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0762r0.pdf>how std::expected interacts with boost.outcome</a><li><a href=https://open-std.org/JTC1/SC22/WG21/docs/papers/2020/p2125r0.pdf>what is vocabulary type?</a><li><a href=https://builtin.com/software-engineering-perspectives/monads>What is a monad?</a></ul> <div id=gitalk-container></div> <link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet> <script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script> <script>var gitalk=new Gitalk({id:'Error modle and handle',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script> <script defer src=https://wendajiang.github.io/js/main.js></script> <script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script> <script defer src=https://wendajiang.github.io/search_index.en.js></script> <script defer src=https://wendajiang.github.io/js/search.js></script> 