<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>protobuffer etc. | 「靡不有初，鲜克有终」</title><meta content="blog of david" name=description><link href=https://wendajiang.github.io/protoetc/ rel=canonical><meta content="protobuffer etc." property=og:title><meta content="blog of david" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/protoetc/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta property=og:updated_time><meta content="protobuffer etc." property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/protoetc/"
      },
      "headline": "protobuffer etc.",
      "image": ,
      "datePublished": "2022-01-20T17:26:39",
      "dateModified": "",
      "author": {
        "@type": "Organization",
        "name": "protobuffer etc."
      },
      "publisher": {
        "@type": "Organization",
        "name": "protobuffer etc.",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "blog of david"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Protoetc",
            "item": "https://wendajiang.github.io/protoetc/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/protoetc/#protobuf2-yu-yan>protobuf2 语言</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#ding-yi-message>定义 message</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#san-chong-biao-shi-fu>三种标识符</a><li><a href=https://wendajiang.github.io/protoetc/#reserved-field>reserved field</a></ul><li><a href=https://wendajiang.github.io/protoetc/#scalar-value-types>Scalar Value Types</a><li><a href=https://wendajiang.github.io/protoetc/#optional-fields-and-default-values>Optional Fields and Default Values</a><li><a href=https://wendajiang.github.io/protoetc/#enumerations>Enumerations</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#reserved-values>Reserved Values</a></ul><li><a href=https://wendajiang.github.io/protoetc/#import>Import</a><li><a href=https://wendajiang.github.io/protoetc/#lei-xing-qian-tao>类型嵌套</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#groups>Groups</a></ul><li><a href=https://wendajiang.github.io/protoetc/#geng-xin-message>更新 Message</a><li><a href=https://wendajiang.github.io/protoetc/#extensions>Extensions</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#qian-tao>嵌套</a><li><a href=https://wendajiang.github.io/protoetc/#xuan-ze-kuo-zhan-shu-zi>选择扩展数字</a></ul><li><a href=https://wendajiang.github.io/protoetc/#oneof>Oneof</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#shi-yong-oneof>使用 Oneof</a><li><a href=https://wendajiang.github.io/protoetc/#oneof-te-xing>Oneof 特性</a><li><a href=https://wendajiang.github.io/protoetc/#hou-xiang-jian-rong-wen-ti>后向兼容问题</a></ul><li><a href=https://wendajiang.github.io/protoetc/#maps>Maps</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#te-xing>特性</a><li><a href=https://wendajiang.github.io/protoetc/#jian-rong>兼容</a></ul><li><a href=https://wendajiang.github.io/protoetc/#ding-yi-fu-wu>定义服务</a><li><a href=https://wendajiang.github.io/protoetc/#options>Options</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#custom-options>custom options</a></ul></ul><li><a href=https://wendajiang.github.io/protoetc/#protobuf3-yu-yan>protobuf3 语言</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#define-a-message-type>define a message type</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#reverse-field>Reverse field</a></ul><li><a href=https://wendajiang.github.io/protoetc/#scalar-value-types-1>Scalar Value Types</a><li><a href=https://wendajiang.github.io/protoetc/#mo-ren-zhi>默认值</a><li><a href=https://wendajiang.github.io/protoetc/#enumerations-1>Enumerations</a><li><a href=https://wendajiang.github.io/protoetc/#unknown-fields>Unknown Fields</a><li><a href=https://wendajiang.github.io/protoetc/#any>Any</a><li><a href=https://wendajiang.github.io/protoetc/#json-mapping>JSON mapping</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#json-options>JSON options</a></ul></ul><li><a href=https://wendajiang.github.io/protoetc/#protobuf-style>protobuf style</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#biao-zhun-wen-jian-ge-shi>标准文件格式</a><li><a href=https://wendajiang.github.io/protoetc/#wen-jian-jie-gou>文件结构</a><li><a href=https://wendajiang.github.io/protoetc/#packages>Packages</a><li><a href=https://wendajiang.github.io/protoetc/#message-he-field-names>Message 和 field names</a><li><a href=https://wendajiang.github.io/protoetc/#repeated-fields>Repeated fields</a><li><a href=https://wendajiang.github.io/protoetc/#enums>Enums</a><li><a href=https://wendajiang.github.io/protoetc/#services>Services</a><li><a href=https://wendajiang.github.io/protoetc/#things-to-avoid>Things to avoid</a></ul><li><a href=https://wendajiang.github.io/protoetc/#bian-ma>编码</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#a-simple-message>A simple Message</a><li><a href=https://wendajiang.github.io/protoetc/#base-128-varints>Base 128 Varints</a><li><a href=https://wendajiang.github.io/protoetc/#message-structure>Message Structure</a><li><a href=https://wendajiang.github.io/protoetc/#more-value-types>More Value Types</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#signed-integers>Signed Integers</a><li><a href=https://wendajiang.github.io/protoetc/#non-varint-number>Non-Varint Number</a><li><a href=https://wendajiang.github.io/protoetc/#strings>Strings</a></ul><li><a href=https://wendajiang.github.io/protoetc/#embedded-messages>Embedded Messages</a><li><a href=https://wendajiang.github.io/protoetc/#optional-and-repeated-elements>Optional and Repeated Elements</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#packed-repeated-fields>Packed Repeated Fields</a></ul><li><a href=https://wendajiang.github.io/protoetc/#field-order>Field Order</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#implications-han-yi>Implications 含义</a></ul></ul><li><a href=https://wendajiang.github.io/protoetc/#xu-lie-hua-yuan-li>序列化原理</a></li><ul><li><a href=https://wendajiang.github.io/protoetc/#protobuf-de-shi-yong>protobuf 的使用</a><li><a href=https://wendajiang.github.io/protoetc/#bian-ma-yuan-li-zhong-dian-shi-lei-xing-he-yu-hao>编码原理（重点是类型和域号）</a></ul><li><a href=https://wendajiang.github.io/protoetc/#cap-n-proto>cap'n proto</a><li><a href=https://wendajiang.github.io/protoetc/#cpp-serializers-dui-bi-benchmark>cpp-serializers 对比 benchmark</a><li><a href=https://wendajiang.github.io/protoetc/#geng-xin-ji-lu>更新记录</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>protobuffer etc.</h1><p><small>Posted 2022-01-20 17:26:39 ‐ <strong>35 min read</strong></small><p><div class=category-area>「 <a href=https://wendajiang.github.io/tags/protobuf> <div class=category>protobuf</div> </a><a href="https://wendajiang.github.io/tags/capn proto"> <div class=category>capn proto</div> </a><a href=https://wendajiang.github.io/tags/flatterproto> <div class=category>flatterproto</div> </a> 」</div></div><h1 id=protobuf2-yu-yan><a aria-label="Anchor link for: protobuf2-yu-yan" class=zola-anchor href=#protobuf2-yu-yan>protobuf2 语言</a></h1><p><a href=https://developers.google.com/protocol-buffers/docs/proto>原文</a><h2 id=ding-yi-message><a aria-label="Anchor link for: ding-yi-message" class=zola-anchor href=#ding-yi-message>定义 message</a></h2><h3 id=san-chong-biao-shi-fu><a aria-label="Anchor link for: san-chong-biao-shi-fu" class=zola-anchor href=#san-chong-biao-shi-fu>三种标识符</a></h3><ul><li>required<li>optional<li>repeated</ul><p>历史原因，<code>repeated</code> 类型不能高效编码，[packed=true] 新代码可以使用这个选项使得编码更高效<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>repeated int32 samples = 4 [packed=true];
</span><span>repeated ProtoEnum results = 5 [packed=true];
</span></code></pre><h3 id=reserved-field><a aria-label="Anchor link for: reserved-field" class=zola-anchor href=#reserved-field>reserved field</a></h3><p>如果删除了 field 或者注释掉，未来可能会重用，这很危险，所以使用 <code>reserved</code> 来避免这个问题<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Foo </span><span>{
</span><span>  </span><span style=color:#ff79c6>reserved </span><span style=color:#bd93f9>2</span><span>, </span><span style=color:#bd93f9>15</span><span>, </span><span style=color:#bd93f9>9 </span><span style=color:#ff79c6>to </span><span style=color:#bd93f9>11</span><span>;
</span><span>  </span><span style=color:#ff79c6>reserved </span><span style=color:#f1fa8c>"foo"</span><span>, </span><span style=color:#f1fa8c>"bar"</span><span>;
</span><span>}
</span></code></pre><h2 id=scalar-value-types><a aria-label="Anchor link for: scalar-value-types" class=zola-anchor href=#scalar-value-types>Scalar Value Types</a></h2><p>A scalar message field can have one of the following types – the table shows the type specified in the <code>.proto</code> file, and the corresponding type in the automatically generated class:<table><thead><tr><th style=text-align:left>.proto Type<th style=text-align:left>Notes<th style=text-align:left>C++ Type<th style=text-align:left>Java Type<th style=text-align:left>Python Type[2]<th style=text-align:left>Go Type<tbody><tr><td style=text-align:left>double<td style=text-align:left><td style=text-align:left>double<td style=text-align:left>double<td style=text-align:left>float<td style=text-align:left>*float64<tr><td style=text-align:left>float<td style=text-align:left><td style=text-align:left>float<td style=text-align:left>float<td style=text-align:left>float<td style=text-align:left>*float32<tr><td style=text-align:left>int32<td style=text-align:left>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint32 instead.<td style=text-align:left>int32<td style=text-align:left>int<td style=text-align:left>int<td style=text-align:left>*int32<tr><td style=text-align:left>int64<td style=text-align:left>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint64 instead.<td style=text-align:left>int64<td style=text-align:left>long<td style=text-align:left>int/long[3]<td style=text-align:left>*int64<tr><td style=text-align:left>uint32<td style=text-align:left>Uses variable-length encoding.<td style=text-align:left>uint32<td style=text-align:left>int[1]<td style=text-align:left>int/long[3]<td style=text-align:left>*uint32<tr><td style=text-align:left>uint64<td style=text-align:left>Uses variable-length encoding.<td style=text-align:left>uint64<td style=text-align:left>long[1]<td style=text-align:left>int/long[3]<td style=text-align:left>*uint64<tr><td style=text-align:left>sint32<td style=text-align:left>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int32s.<td style=text-align:left>int32<td style=text-align:left>int<td style=text-align:left>int<td style=text-align:left>*int32<tr><td style=text-align:left>sint64<td style=text-align:left>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int64s.<td style=text-align:left>int64<td style=text-align:left>long<td style=text-align:left>int/long[3]<td style=text-align:left>*int64<tr><td style=text-align:left>fixed32<td style=text-align:left>Always four bytes. More efficient than uint32 if values are often greater than 228.<td style=text-align:left>uint32<td style=text-align:left>int[1]<td style=text-align:left>int/long[3]<td style=text-align:left>*uint32<tr><td style=text-align:left>fixed64<td style=text-align:left>Always eight bytes. More efficient than uint64 if values are often greater than 256.<td style=text-align:left>uint64<td style=text-align:left>long[1]<td style=text-align:left>int/long[3]<td style=text-align:left>*uint64<tr><td style=text-align:left>sfixed32<td style=text-align:left>Always four bytes.<td style=text-align:left>int32<td style=text-align:left>int<td style=text-align:left>int<td style=text-align:left>*int32<tr><td style=text-align:left>sfixed64<td style=text-align:left>Always eight bytes.<td style=text-align:left>int64<td style=text-align:left>long<td style=text-align:left>int/long[3]<td style=text-align:left>*int64<tr><td style=text-align:left>bool<td style=text-align:left><td style=text-align:left>bool<td style=text-align:left>boolean<td style=text-align:left>bool<td style=text-align:left>*bool<tr><td style=text-align:left>string<td style=text-align:left>A string must always contain UTF-8 encoded or 7-bit ASCII text.<td style=text-align:left>string<td style=text-align:left>String<td style=text-align:left>unicode (Python 2) or str (Python 3)<td style=text-align:left>*string<tr><td style=text-align:left>bytes<td style=text-align:left>May contain any arbitrary sequence of bytes.<td style=text-align:left>string<td style=text-align:left>ByteString<td style=text-align:left>bytes<td style=text-align:left>[]byte</table><h2 id=optional-fields-and-default-values><a aria-label="Anchor link for: optional-fields-and-default-values" class=zola-anchor href=#optional-fields-and-default-values>Optional Fields and Default Values</a></h2><p>如果 optional field 没有被设置，序列化会被设置一个默认值，默认值可以定义时写好<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>optional int32 result_per_page = 3 [default = 10];
</span></code></pre><p>如果没有设置：对于 string，默认是空串。对于 bytes，默认也是空。对于 bools， 默认是 false。对于整型，默认是 0。对于 enums，默认是第一个。<h2 id=enumerations><a aria-label="Anchor link for: enumerations" class=zola-anchor href=#enumerations>Enumerations</a></h2><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SearchRequest </span><span>{
</span><span>  </span><span style=color:#ff79c6>required </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>query </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>page_number </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>result_per_page </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3 </span><span>[</span><span style=color:#8be9fd>default </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>10</span><span>];
</span><span>  </span><span style=font-style:italic;color:#8be9fd>enum </span><span>Corpus {
</span><span>    </span><span style=color:#bd93f9>UNIVERSAL </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>0</span><span>;
</span><span>    </span><span style=color:#bd93f9>WEB </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>    </span><span style=color:#bd93f9>IMAGES </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>    </span><span style=color:#bd93f9>LOCAL </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>    </span><span style=color:#bd93f9>NEWS </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>4</span><span>;
</span><span>    </span><span style=color:#bd93f9>PRODUCTS </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>5</span><span>;
</span><span>    </span><span style=color:#bd93f9>VIDEO </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>6</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>Corpus </span><span style=color:#fff>corpus </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>4 </span><span>[</span><span style=color:#8be9fd>default </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>UNIVERSAL</span><span>];
</span><span>}
</span></code></pre><p>可以对于不同的 enum 定义相同的值，但是要声明 <code>allow_alias = true</code>,如果没有声明，protoc 就会报错<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>enum </span><span>EnumAllowingAlias {
</span><span>  </span><span style=font-style:italic;color:#8be9fd>option </span><span>allow_alias </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>true</span><span>;
</span><span>  </span><span style=color:#bd93f9>UNKNOWN </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>0</span><span>;
</span><span>  </span><span style=color:#bd93f9>STARTED </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=color:#bd93f9>RUNNING </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>}
</span><span style=font-style:italic;color:#8be9fd>enum </span><span>EnumNotAllowingAlias {
</span><span>  </span><span style=color:#bd93f9>UNKNOWN </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>0</span><span>;
</span><span>  </span><span style=color:#bd93f9>STARTED </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=color:#6272a4>// RUNNING = 1;  // Uncommenting this line will cause a compile error inside Google and a warning message outside.
</span><span>}
</span></code></pre><p>enum 内容必须是<strong>32位整数</strong>。因为 enum 类型使用 varint encoding，负数的编码效率很低，所以不推荐使用负数<h3 id=reserved-values><a aria-label="Anchor link for: reserved-values" class=zola-anchor href=#reserved-values>Reserved Values</a></h3><p>如果你要删除一些 enum value 或者注释，也要使用 reverved 声明保留，以免后人重用引发问题<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>enum </span><span>Foo {
</span><span>  </span><span style=color:#bd93f9>reserved 2</span><span>, 15, 9 </span><span style=color:#bd93f9>to 11</span><span>, 40 </span><span style=color:#bd93f9>to max</span><span>;
</span><span>  </span><span style=color:#bd93f9>reserved</span><span> "</span><span style=color:#bd93f9>FOO</span><span>", "</span><span style=color:#bd93f9>BAR</span><span>";
</span><span>}
</span></code></pre><h2 id=import><a aria-label="Anchor link for: import" class=zola-anchor href=#import>Import</a></h2><p>将 PB3 的 message import 到 PB2 的文件中使用是可行的，反之亦然。但是 PB2 的 enum 不能用在 PB3 中<h2 id=lei-xing-qian-tao><a aria-label="Anchor link for: lei-xing-qian-tao" class=zola-anchor href=#lei-xing-qian-tao>类型嵌套</a></h2><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SearchResponse </span><span>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Result </span><span>{
</span><span>    </span><span style=color:#ff79c6>required </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>url </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>    </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>title </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>    </span><span style=color:#ff79c6>repeated </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>snippets </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#ff79c6>repeated </span><span style=color:#8be9fd>Result </span><span style=color:#fff>result </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SomeOtherMessage </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span>SearchResponse</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>Result </span><span style=color:#fff>result </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>}
</span></code></pre><h3 id=groups><a aria-label="Anchor link for: groups" class=zola-anchor href=#groups>Groups</a></h3><p>不要用这个特性，同样 required 最好也不要用，这两个特性 PB3 中移除了<h2 id=geng-xin-message><a aria-label="Anchor link for: geng-xin-message" class=zola-anchor href=#geng-xin-message>更新 Message</a></h2><p>这里请看<a href=https://developers.google.com/protocol-buffers/docs/proto#updating>原文</a>，这是更新一个 message 尽可能遵守的原则<h2 id=extensions><a aria-label="Anchor link for: extensions" class=zola-anchor href=#extensions>Extensions</a></h2><p>extensions 可以让你在 message 声明一些 field numbers 给第三方 extensions 使用。extensions 是占位符，field number 没有在本 .proto 文件中定义。允许其他 .proto 文件定义这些 field number，看个例子：<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Foo </span><span>{
</span><span>  </span><span style=color:#6272a4>// ...
</span><span>  </span><span style=color:#ff79c6>extensions </span><span style=color:#bd93f9>100 </span><span style=color:#ff79c6>to </span><span style=color:#bd93f9>199</span><span>;
</span><span>}
</span></code></pre><p>这表明 [100,199] 保留给 extensions 使用。其他用户可以通过 import 这个文件定义 Foo 的 field number，比如<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=color:#ff79c6>extend </span><span style=color:#8be9fd>Foo </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>bar </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>126</span><span>;
</span><span>}
</span></code></pre><p>在访问 extend 的字段时，代码与一般定义的不同，比如 C++ 中<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>Foo foo;
</span><span>foo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>SetExtension</span><span>(bar, </span><span style=color:#bd93f9>15</span><span>);
</span></code></pre><p>Extensions 可以是已经提到任意类型，不能是后面提到的 oneof 或者 map<h3 id=qian-tao><a aria-label="Anchor link for: qian-tao" class=zola-anchor href=#qian-tao>嵌套</a></h3><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Baz </span><span>{
</span><span>  </span><span style=color:#ff79c6>extend </span><span style=color:#8be9fd>Foo </span><span>{
</span><span>    </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>bar </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>126</span><span>;
</span><span>  }
</span><span>  ...
</span><span>}
</span></code></pre><p>代码使用类似这样:<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>Foo foo;
</span><span>foo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>SetExtensino</span><span>(Baz</span><span style=color:#ff79c6>::</span><span>bar, </span><span style=color:#bd93f9>15</span><span>);
</span></code></pre><p>影响就是 Foo 的扩展定义位于 message 的 scope，C++ 就是名字空间加了限制<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Baz </span><span>{
</span><span>  ...
</span><span>}
</span><span>
</span><span style=color:#6272a4>// This can even be in a different file.
</span><span style=color:#ff79c6>extend </span><span style=color:#8be9fd>Foo </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>Baz </span><span style=color:#fff>foo_baz_ext </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>127</span><span>;
</span><span>}
</span></code></pre><p>这样的写法可能更清晰<h3 id=xuan-ze-kuo-zhan-shu-zi><a aria-label="Anchor link for: xuan-ze-kuo-zhan-shu-zi" class=zola-anchor href=#xuan-ze-kuo-zhan-shu-zi>选择扩展数字</a></h3><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Foo </span><span>{
</span><span>  </span><span style=color:#ff79c6>extensions </span><span style=color:#bd93f9>1000 </span><span style=color:#ff79c6>to </span><span style=color:#bd93f9>max</span><span>;
</span><span>}
</span></code></pre><p>max 是 $2^{29} - 1$，或者 536,870,911<p>与一般选择 field number 一样，也要避免使用 19000 到 10000（FieldDescriptor :: kFirstReservedNumber到FieldDescriptor :: kLastReservedNumber）这是为 PB 实现保留的。<h2 id=oneof><a aria-label="Anchor link for: oneof" class=zola-anchor href=#oneof>Oneof</a></h2><p>如果你的 message 中有很多 optional 的字段，并且同时最多只有一个 optional 的字段会被 set，那么可以使用 oneof 特性来提升编码效率，进一步压缩空间。类似 CPP 中 UNION<h3 id=shi-yong-oneof><a aria-label="Anchor link for: shi-yong-oneof" class=zola-anchor href=#shi-yong-oneof>使用 Oneof</a></h3><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SampleMessage </span><span>{
</span><span>  </span><span style=color:#ff79c6>oneof </span><span>test_oneof {
</span><span>    </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>name </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>4</span><span>;
</span><span>    </span><span style=color:#8be9fd>SubMessage </span><span style=color:#fff>sub_message </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>9</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><p>oneof 中定义的字段不能使用 required, optional, repeated 标识关键字。如果需要增加一个 repeated 字段，需要使用 Message 包裹起来<h3 id=oneof-te-xing><a aria-label="Anchor link for: oneof-te-xing" class=zola-anchor href=#oneof-te-xing>Oneof 特性</a></h3><ul><li>set 其中一个字段，其他字段都被清空，所以只会最后一个 set 的生效<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>SampleMessage message;
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>set_name</span><span>(</span><span style=color:#f1fa8c>"name"</span><span>);
</span><span style=color:#50fa7b>CHECK</span><span>(message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>has_name</span><span>());
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>mutable_sub_message</span><span>();   </span><span style=color:#6272a4>// Will clear name field.
</span><span style=color:#50fa7b>CHECK</span><span>(</span><span style=color:#ff79c6>!</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>has_name</span><span>());
</span></code></pre><li>如果解析器看到 oneof 中有多个字段，解析出来的 message 只会是最后一个<li>Extensions 不支持 oneof<li>反射 API 也可以用于 oneof<li>可以设置一个 oneof 字段默认值，然后最后一个被序列化<li>如果使用 C++，注意代码不要 crash。下面的代码就会 crash，因为 sub_message 已经被删除了，当调用 set_name 时<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>SampleMessage message;
</span><span>Submessage </span><span style=color:#ff79c6>*</span><span>sub_message </span><span style=color:#ff79c6>=</span><span> message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>mutable_sub_message</span><span>();
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>set_name</span><span>(</span><span style=color:#f1fa8c>"name"</span><span>); </span><span style=color:#6272a4>// will delete sub_message
</span><span>sub_message</span><span style=color:#ff79c6>-></span><span style=color:#fff>set_</span><span style=color:#ff79c6>... </span><span style=color:#6272a4>// crash here
</span></code></pre><li>还是 C++，如果你 Swap 两个有 oneof 特性的 message，会有对方最后一个 oneof，例子中， msg1 有 sub_message， msg2 有 name<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>SampleMessage msg1;
</span><span>msg1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>set_name</span><span>(</span><span style=color:#f1fa8c>"name"</span><span>);
</span><span>SampleMessage msg2;
</span><span>msg2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>mutable_sub_message</span><span>();
</span><span>msg1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>swap</span><span>(</span><span style=color:#ff79c6>&</span><span>msg2);
</span><span style=color:#50fa7b>CHECK</span><span>(msg1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>has_sub_message</span><span>());
</span><span style=color:#50fa7b>CHECK</span><span>(msg2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>has_name</span><span>());
</span></code></pre></ul><h3 id=hou-xiang-jian-rong-wen-ti><a aria-label="Anchor link for: hou-xiang-jian-rong-wen-ti" class=zola-anchor href=#hou-xiang-jian-rong-wen-ti>后向兼容问题</a></h3><p>注意增加，删除 oneof 字段时，如果 check 返回 None/NOT_SET，意味着 oneof 没有被 set 或者设置其他版本的 oneof。无法区分<p>所以 ！！！ 就认为 oneof 没有兼容性<h2 id=maps><a aria-label="Anchor link for: maps" class=zola-anchor href=#maps>Maps</a></h2><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>map&LTkey_type, value_type> map_field = N;
</span></code></pre><p><strong>key_type 任意整数类型或者字符串类型。注意 enum 不能作为 key_type。value_type 可以是出了 map 之外的任何类型</strong><p>map API 现在支持所有 PB2 的语言<h3 id=te-xing><a aria-label="Anchor link for: te-xing" class=zola-anchor href=#te-xing>特性</a></h3><ul><li>Extensions 不支持 map<li>maps 不使用 repeated, optional, required<li>Wire format 顺序和 map 迭代是不确定的<li>生成文本格式时，map 通过 key 排序，数字 key 以数字顺序<li>从 wire 格式解析，或者 merging，如果有重复 map key，使用后面的值。解析文本格式，如果有重复 key 就会报错</ul><h3 id=jian-rong><a aria-label="Anchor link for: jian-rong" class=zola-anchor href=#jian-rong>兼容</a></h3><p>map 只是一个语法糖，实际上与下面的定义相等，所以即使 PB 实现不支持 map，也可以处理数据<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>MapFieldEntry </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>key_type </span><span style=color:#fff>key </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>value_type </span><span style=color:#fff>value </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>}
</span><span>
</span><span>repeated MapFieldEntry map_field = N;
</span></code></pre><h2 id=ding-yi-fu-wu><a aria-label="Anchor link for: ding-yi-fu-wu" class=zola-anchor href=#ding-yi-fu-wu>定义服务</a></h2><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>service </span><span style=text-decoration:underline;color:#8be9fd>SearchService </span><span>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>rpc </span><span style=color:#50fa7b>Search</span><span>(</span><span style=color:#8be9fd>SearchRequest</span><span>) </span><span style=color:#ff79c6>returns </span><span>(</span><span style=color:#8be9fd>SearchResponse</span><span>);
</span><span>}
</span></code></pre><p>默认，PB 编译器会生成抽象接口 <code>SearchService</code> 以及关联 stub 实现。stub 传递所有的调用为 RpcChannel，是一个抽象接口，你需要自己定义接口逻辑。比如，你可以将 RpcChannel 实现为序列化一个 message 然后通过 HTTP 发送到一个服务端。换句话说，生成的 stub 提供了一个类型安全的接口，并没有限制你做任何实现。所以，C++代码的例子如下：<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>using</span><span> google</span><span style=color:#ff79c6>::</span><span>protobuf;
</span><span>
</span><span>protobuf</span><span style=color:#ff79c6>::</span><span>RpcChannel</span><span style=color:#ff79c6>*</span><span> channel;
</span><span>protobuf</span><span style=color:#ff79c6>::</span><span>RpcController</span><span style=color:#ff79c6>*</span><span> controller;
</span><span>SearchService</span><span style=color:#ff79c6>*</span><span> service;
</span><span>SearchRequest request;
</span><span>SearchResponse response;
</span><span>
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>DoSearch</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#6272a4>// You provide classes MyRpcChannel and MyRpcController, which implement
</span><span>  </span><span style=color:#6272a4>// the abstract interfaces protobuf::RpcChannel and protobuf::RpcController.
</span><span>  channel </span><span style=color:#ff79c6>= new </span><span style=color:#50fa7b>MyRpcChannel</span><span>(</span><span style=color:#f1fa8c>"somehost.example.com:1234"</span><span>);
</span><span>  controller </span><span style=color:#ff79c6>= new</span><span> MyRpcController;
</span><span>
</span><span>  </span><span style=color:#6272a4>// The protocol compiler generates the SearchService class based on the
</span><span>  </span><span style=color:#6272a4>// definition given above.
</span><span>  service </span><span style=color:#ff79c6>= new </span><span>SearchService</span><span style=color:#ff79c6>::</span><span style=color:#50fa7b>Stub</span><span>(channel);
</span><span>
</span><span>  </span><span style=color:#6272a4>// Set up the request.
</span><span>  request</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>set_query</span><span>(</span><span style=color:#f1fa8c>"protocol buffers"</span><span>);
</span><span>
</span><span>  </span><span style=color:#6272a4>// Execute the RPC.
</span><span>  service</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>Search</span><span>(controller, request, response, protobuf</span><span style=color:#ff79c6>::</span><span style=color:#50fa7b>NewCallback</span><span>(</span><span style=color:#ff79c6>&</span><span>Done));
</span><span style=color:#fff>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>Done</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#ff79c6>delete</span><span> service;
</span><span>  </span><span style=color:#ff79c6>delete</span><span> channel;
</span><span>  </span><span style=color:#ff79c6>delete</span><span> controller;
</span><span style=color:#fff>}
</span></code></pre><p>所有的 service 类实现 Service 接口，这样提供了编译器不知道方法名称或者输入输出类型的进行调用的方法。服务端，可以这样实现：<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>using</span><span> google</span><span style=color:#ff79c6>::</span><span>protobuf;
</span><span>
</span><span style=font-style:italic;color:#8be9fd>class </span><span style=text-decoration:underline;color:#8be9fd>ExampleSearchService </span><span>: </span><span style=color:#ff79c6>public </span><span style=text-decoration:underline;font-style:italic;color:#8be9fd>SearchService </span><span style=color:#fff>{
</span><span> </span><span style=color:#ff79c6>public</span><span>:
</span><span>  </span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>Search</span><span>(protobuf</span><span style=color:#ff79c6>::</span><span>RpcController</span><span style=color:#ff79c6>* </span><span style=font-style:italic;color:#ffb86c>controller</span><span>,
</span><span>              </span><span style=color:#ff79c6>const</span><span> SearchRequest</span><span style=color:#ff79c6>* </span><span style=font-style:italic;color:#ffb86c>request</span><span>,
</span><span>              SearchResponse</span><span style=color:#ff79c6>* </span><span style=font-style:italic;color:#ffb86c>response</span><span>,
</span><span>              protobuf</span><span style=color:#ff79c6>::</span><span>Closure</span><span style=color:#ff79c6>* </span><span style=font-style:italic;color:#ffb86c>done</span><span>) </span><span style=color:#fff>{
</span><span>    </span><span style=color:#ff79c6>if </span><span>(request</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>query</span><span>() </span><span style=color:#ff79c6>== </span><span style=color:#f1fa8c>"google"</span><span>) </span><span style=color:#fff>{
</span><span>      response</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>add_result</span><span>()</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>set_url</span><span>(</span><span style=color:#f1fa8c>"http://www.google.com"</span><span>);
</span><span>    </span><span style=color:#fff>} </span><span style=color:#ff79c6>else if </span><span>(request</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>query</span><span>() </span><span style=color:#ff79c6>== </span><span style=color:#f1fa8c>"protocol buffers"</span><span>) </span><span style=color:#fff>{
</span><span>      response</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>add_result</span><span>()</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>set_url</span><span>(</span><span style=color:#f1fa8c>"http://protobuf.googlecode.com"</span><span>);
</span><span>    </span><span style=color:#fff>}
</span><span>    done</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>Run</span><span>();
</span><span>  </span><span style=color:#fff>}
</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span style=font-style:italic;color:#8be9fd>int </span><span style=color:#50fa7b>main</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#6272a4>// You provide class MyRpcServer.  It does not have to implement any
</span><span>  </span><span style=color:#6272a4>// particular interface; this is just an example.
</span><span>  MyRpcServer server;
</span><span>
</span><span>  protobuf</span><span style=color:#ff79c6>::</span><span>Service</span><span style=color:#ff79c6>*</span><span> service </span><span style=color:#ff79c6>= new</span><span> ExampleSearchService;
</span><span>  server</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ExportOnPort</span><span>(</span><span style=color:#bd93f9>1234</span><span>, service);
</span><span>  server</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Run</span><span>();
</span><span>
</span><span>  </span><span style=color:#ff79c6>delete</span><span> service;
</span><span>  </span><span style=color:#ff79c6>return </span><span style=color:#bd93f9>0</span><span>;
</span><span style=color:#fff>}
</span></code></pre><p>如果不想实现你自己的 RPC 系统，可以直接使用 gRPC。<h2 id=options><a aria-label="Anchor link for: options" class=zola-anchor href=#options>Options</a></h2><p><code>.proto</code>文件可以通过 <em>options</em> 来 annotate，会影响处理的上下文。所有的 <em>options</em> 定义在 <code>google.protobuf/descriptor.proto</code><ul><li>file-level options<li>Message-level options<li>filed-level options</ul><p>比如：<ul><li><p>java_package (file option)</p> <pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>option </span><span>java_package </span><span style=color:#ff79c6>= </span><span style=color:#f1fa8c>"com.example.foo"</span><span>;
</span></code></pre> <p>生成的 java 代码 package</p><li><p>optimize_for (file option) SPEED(default), CODE_SIZE, LITE_RUNTIME 会影响 C++ 和 Java 代码的生成</p><li><p>message_set_wire_format (message option) 对于C++代码开启 arena allocation</p> <pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Foo </span><span>{
</span><span>	</span><span style=font-style:italic;color:#8be9fd>option </span><span>message_set_wire_format </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>true</span><span>;
</span><span>	</span><span style=color:#ff79c6>extensions </span><span style=color:#bd93f9>4 </span><span style=color:#ff79c6>to </span><span style=color:#bd93f9>max</span><span>;
</span><span>}
</span></code></pre> <p>只是例子，Google 之外的开发者不需要这个</p><li><p>packed (field option)：如果在 repeated numeric type 上开启，encode 更加紧凑，这个 option 没有坏处，pb3 默认开启</p> <pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>repeated int32 samples = 4 [packed = true];
</span></code></pre><li><p>deprecated (filed option): 开启表明这个 filed 废弃，Java 中会加上 @Deprecated 注解</p></ul><h3 id=custom-options><a aria-label="Anchor link for: custom-options" class=zola-anchor href=#custom-options>custom options</a></h3><p>还可以自定义 options<p>example:<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=color:#ff79c6>import </span><span style=color:#f1fa8c>"google/protobuf/descriptor.proto"
</span><span>
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>MessageOptions </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>my_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>51234</span><span>;
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>MyMessage </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional</span><span> (</span><span style=color:#8be9fd>my_option</span><span>) = "</span><span style=color:#8be9fd>Hello </span><span style=color:#fff>world</span><span>!";
</span><span>}
</span><span>
</span><span style=color:#6272a4>// 这样我们定义了 message-level option
</span></code></pre><p>然后 C++ 中可以这样使用<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>string value </span><span style=color:#ff79c6>= </span><span>MyMessage</span><span style=color:#ff79c6>::</span><span style=color:#50fa7b>descriptor</span><span>()</span><span style=color:#ff79c6>-></span><span style=color:#50fa7b>options</span><span>()</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>GetExtension</span><span>(my_option);
</span></code></pre><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=color:#ff79c6>import </span><span style=color:#f1fa8c>"google/protobuf/descriptor.proto"
</span><span>
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>FileOptions </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>my_file_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50000</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>MessageOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>my_message_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50001</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>FieldOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>float </span><span style=color:#fff>my_field_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50002</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>OneofOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int64 </span><span style=color:#fff>my_oneof_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50003</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>EnumOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>bool </span><span style=color:#fff>my_enum_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50004</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>EnumValueOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>uint32 </span><span style=color:#fff>my_enum_value_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50005</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>ServiceOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>MyEnum </span><span style=color:#fff>my_service_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50006</span><span>;
</span><span>}
</span><span style=color:#ff79c6>extend </span><span>google</span><span style=color:#ff79c6>.</span><span>protobuf</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>MethodOptions </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>MyMessage </span><span style=color:#fff>my_method_option </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>50007</span><span>;
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_file_option) </span><span style=color:#ff79c6>= </span><span style=color:#f1fa8c>"Hello world!"</span><span>;
</span><span>
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>MyMessage </span><span>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_message_option) </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1234</span><span>;
</span><span>
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>foo </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1 </span><span>[(my_field_option) </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>4.5</span><span>];
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>bar </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>  </span><span style=color:#ff79c6>oneof </span><span>qux {
</span><span>    </span><span style=color:#8be9fd>option</span><span> (</span><span style=color:#8be9fd>my_oneof_option</span><span>) = 42;
</span><span>
</span><span>    </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>quux </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>  }
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>enum </span><span>MyEnum {
</span><span>  </span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_enum_option) </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>true</span><span>;
</span><span>
</span><span>  </span><span style=color:#bd93f9>FOO </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1 </span><span>[(my_enum_value_option) </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>321</span><span>];
</span><span>  </span><span style=color:#bd93f9>BAR </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>RequestType </span><span>{}
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>ResponseType </span><span>{}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>service </span><span style=text-decoration:underline;color:#8be9fd>MyService </span><span>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_service_option) </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>FOO</span><span>;
</span><span>
</span><span>  </span><span style=font-style:italic;color:#8be9fd>rpc </span><span style=color:#50fa7b>MyMethod</span><span>(</span><span style=color:#8be9fd>RequestType</span><span>) </span><span style=color:#ff79c6>returns</span><span>(</span><span style=color:#8be9fd>ResponseType</span><span>) {
</span><span>    </span><span style=color:#6272a4>// Note:  my_method_option has type MyMessage.  We can set each field
</span><span>    </span><span style=color:#6272a4>//   within it using a separate "option" line.
</span><span>    </span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_method_option)</span><span style=color:#ff79c6>.</span><span>foo </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>567</span><span>;
</span><span>    </span><span style=font-style:italic;color:#8be9fd>option </span><span>(my_method_option)</span><span style=color:#ff79c6>.</span><span>bar </span><span style=color:#ff79c6>= </span><span style=color:#f1fa8c>"Some string"</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><h1 id=protobuf3-yu-yan><a aria-label="Anchor link for: protobuf3-yu-yan" class=zola-anchor href=#protobuf3-yu-yan>protobuf3 语言</a></h1><p><a href=https://developers.google.com/protocol-buffers/docs/proto3>原文</a><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=color:#ff79c6>syntax = </span><span style=color:#f1fa8c>"proto3"</span><span>;
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SearchRequest </span><span>{
</span><span>  </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>query </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>page_number </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>  </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>result_per_page </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>}
</span></code></pre><p>需要声明 syntax = "proto3"<p>同 PB2 一样，tag number 范围 $1 到 2^{29} - 1$，并且不能使用 19000 到 19999<p>PB3 默认是 optional，没有 required 关键字，还有 repeated，并且 repeated 默认使用 packed 特性编码<h2 id=define-a-message-type><a aria-label="Anchor link for: define-a-message-type" class=zola-anchor href=#define-a-message-type>define a message type</a></h2><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=color:#ff79c6>syntax = </span><span style=color:#f1fa8c>"proto3"</span><span>;
</span><span>
</span><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SearchRequest </span><span>{
</span><span>	</span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>query </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>	</span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>page_number </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>	</span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>result_per_page </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>}
</span><span>
</span><span style=color:#6272a4>// 默认是 optional , repeated 才需要声明
</span></code></pre><h3 id=reverse-field><a aria-label="Anchor link for: reverse-field" class=zola-anchor href=#reverse-field>Reverse field</a></h3><p>同 pb2 中的内容<h2 id=scalar-value-types-1><a aria-label="Anchor link for: scalar-value-types-1" class=zola-anchor href=#scalar-value-types-1>Scalar Value Types</a></h2><p>与 PB2 基本一样，不过 string 和 bytes 加了最长限制<ul><li>string 不能超过 $2^{32}$<li>bytes 不能超过 $2^{32}$</ul><h2 id=mo-ren-zhi><a aria-label="Anchor link for: mo-ren-zhi" class=zola-anchor href=#mo-ren-zhi>默认值</a></h2><ul><li>string，默认空串<li>bytes，默认空序列<li>bool，默认 false<li>整型，默认 0<li>enum，默认第一个，必须是0<li>message 字段，看特定语言 API<li>repeated，默认没有</ul><h2 id=enumerations-1><a aria-label="Anchor link for: enumerations-1" class=zola-anchor href=#enumerations-1>Enumerations</a></h2><ul><li>PB3 中第一是0，作为默认值<li>0 必须是第一个元素，为了与 PB2 兼容，作为默认值</ul><p>PB2 不要求 0 是第一个值<h2 id=unknown-fields><a aria-label="Anchor link for: unknown-fields" class=zola-anchor href=#unknown-fields>Unknown Fields</a></h2><p>老代码解析新数据，可能有不认识的 field<p>最开始，pb3 在碰到不识别的 field，简单丢弃，在 version 3.5 我们为了匹配 pb2 行为重新引入了保护机制。在 version 3.5 或者更新，在解析过程中不认识的 field 被保留，不会删除<h2 id=any><a aria-label="Anchor link for: any" class=zola-anchor href=#any>Any</a></h2><p>特性开发中，有点类似 pb2 中的 message extensions 机制<h2 id=json-mapping><a aria-label="Anchor link for: json-mapping" class=zola-anchor href=#json-mapping>JSON mapping</a></h2><p>PB3 支持了官方的对 JSON 的编码，方便与系统之间共享数据。<p>If a value is missing in the JSON-encoded data or if its value is <code>null</code>, it will be interpreted as the appropriate <a href=https://developers.google.com/protocol-buffers/docs/proto3#default>default value</a> when parsed into a protocol buffer. If a field has the default value in the protocol buffer, it will be omitted in the JSON-encoded data by default to save space. An implementation may provide options to emit fields with default values in the JSON-encoded output.<table><thead><tr><th style=text-align:left>proto3<th style=text-align:left>JSON<th style=text-align:left>JSON example<th style=text-align:left>Notes<tbody><tr><td style=text-align:left>message<td style=text-align:left>object<td style=text-align:left><code>{"fooBar": v, "g": null, …}</code><td style=text-align:left>Generates JSON objects. Message field names are mapped to lowerCamelCase and become JSON object keys. If the <code>json_name</code> field option is specified, the specified value will be used as the key instead. Parsers accept both the lowerCamelCase name (or the one specified by the <code>json_name</code> option) and the original proto field name. <code>null</code> is an accepted value for all field types and treated as the default value of the corresponding field type.<tr><td style=text-align:left>enum<td style=text-align:left>string<td style=text-align:left><code>"FOO_BAR"</code><td style=text-align:left>The name of the enum value as specified in proto is used. Parsers accept both enum names and integer values.<tr><td style=text-align:left>map&LTK,V><td style=text-align:left>object<td style=text-align:left><code>{"k": v, …}</code><td style=text-align:left>All keys are converted to strings.<tr><td style=text-align:left>repeated V<td style=text-align:left>array<td style=text-align:left><code>[v, …]</code><td style=text-align:left><code>null</code> is accepted as the empty list <code>[]</code>.<tr><td style=text-align:left>bool<td style=text-align:left>true, false<td style=text-align:left><code>true, false</code><td style=text-align:left><tr><td style=text-align:left>string<td style=text-align:left>string<td style=text-align:left><code>"Hello World!"</code><td style=text-align:left><tr><td style=text-align:left>bytes<td style=text-align:left>base64 string<td style=text-align:left><code>"YWJjMTIzIT8kKiYoKSctPUB+"</code><td style=text-align:left>JSON value will be the data encoded as a string using standard base64 encoding with paddings. Either standard or URL-safe base64 encoding with/without paddings are accepted.<tr><td style=text-align:left>int32, fixed32, uint32<td style=text-align:left>number<td style=text-align:left><code>1, -10, 0</code><td style=text-align:left>JSON value will be a decimal number. Either numbers or strings are accepted.<tr><td style=text-align:left>int64, fixed64, uint64<td style=text-align:left>string<td style=text-align:left><code>"1", "-10"</code><td style=text-align:left>JSON value will be a decimal string. Either numbers or strings are accepted.<tr><td style=text-align:left>float, double<td style=text-align:left>number<td style=text-align:left><code>1.1, -10.0, 0, "NaN", "Infinity"</code><td style=text-align:left>JSON value will be a number or one of the special string values "NaN", "Infinity", and "-Infinity". Either numbers or strings are accepted. Exponent notation is also accepted. -0 is considered equivalent to 0.<tr><td style=text-align:left>Any<td style=text-align:left><code>object</code><td style=text-align:left><code>{"@type": "url", "f": v, … }</code><td style=text-align:left>If the Any contains a value that has a special JSON mapping, it will be converted as follows: <code>{"@type": xxx, "value": yyy}</code>. Otherwise, the value will be converted into a JSON object, and the <code>"@type"</code> field will be inserted to indicate the actual data type.<tr><td style=text-align:left>Timestamp<td style=text-align:left>string<td style=text-align:left><code>"1972-01-01T10:00:20.021Z"</code><td style=text-align:left>Uses RFC 3339, where generated output will always be Z-normalized and uses 0, 3, 6 or 9 fractional digits. Offsets other than "Z" are also accepted.<tr><td style=text-align:left>Duration<td style=text-align:left>string<td style=text-align:left><code>"1.000340012s", "1s"</code><td style=text-align:left>Generated output always contains 0, 3, 6, or 9 fractional digits, depending on required precision, followed by the suffix "s". Accepted are any fractional digits (also none) as long as they fit into nano-seconds precision and the suffix "s" is required.<tr><td style=text-align:left>Struct<td style=text-align:left><code>object</code><td style=text-align:left><code>{ … }</code><td style=text-align:left>Any JSON object. See <code>struct.proto</code>.<tr><td style=text-align:left>Wrapper types<td style=text-align:left>various types<td style=text-align:left><code>2, "2", "foo", true, "true", null, 0, …</code><td style=text-align:left>Wrappers use the same representation in JSON as the wrapped primitive type, except that <code>null</code> is allowed and preserved during data conversion and transfer.<tr><td style=text-align:left>FieldMask<td style=text-align:left>string<td style=text-align:left><code>"f.fooBar,h"</code><td style=text-align:left>See <code>field_mask.proto</code>.<tr><td style=text-align:left>ListValue<td style=text-align:left>array<td style=text-align:left><code>[foo, bar, …]</code><td style=text-align:left><tr><td style=text-align:left>Value<td style=text-align:left>value<td style=text-align:left><td style=text-align:left>Any JSON value. Check <a href=https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#google.protobuf.Value>google.protobuf.Value</a> for details.<tr><td style=text-align:left>NullValue<td style=text-align:left>null<td style=text-align:left><td style=text-align:left>JSON null<tr><td style=text-align:left>Empty<td style=text-align:left>object<td style=text-align:left><code>{}</code><td style=text-align:left>An empty JSON object</table><h3 id=json-options><a aria-label="Anchor link for: json-options" class=zola-anchor href=#json-options>JSON options</a></h3><p>A proto3 JSON implementation may provide the following options:<ul><li><strong>Emit fields with default values</strong>: Fields with default values are omitted by default in proto3 JSON output. An implementation may provide an option to override this behavior and output fields with their default values.<li><strong>Ignore unknown fields</strong>: Proto3 JSON parser should reject unknown fields by default but may provide an option to ignore unknown fields in parsing.<li><strong>Use proto field name instead of lowerCamelCase name</strong>: By default proto3 JSON printer should convert the field name to lowerCamelCase and use that as the JSON name. An implementation may provide an option to use proto field name as the JSON name instead. Proto3 JSON parsers are required to accept both the converted lowerCamelCase name and the proto field name.<li><strong>Emit enum values as integers instead of strings</strong>: The name of an enum value is used by default in JSON output. An option may be provided to use the numeric value of the enum value instead.</ul><h1 id=protobuf-style><a aria-label="Anchor link for: protobuf-style" class=zola-anchor href=#protobuf-style>protobuf style</a></h1><p><a href=https://developers.google.com/protocol-buffers/docs/style>原文</a><p>请注意，PB 已经随着时间而发展，因此你可能会看到不同风格编写的 .proto 文件，修改这些文件时，请尊重现有风格，一致性是关键。但是创建新的 .proto 文件时，请采用当前的最新风格<h2 id=biao-zhun-wen-jian-ge-shi><a aria-label="Anchor link for: biao-zhun-wen-jian-ge-shi" class=zola-anchor href=#biao-zhun-wen-jian-ge-shi>标准文件格式</a></h2><ul><li>每行不超过 80 字符<li>使用 2 空格缩进<li>最好对字符串使用双引号</ul><h2 id=wen-jian-jie-gou><a aria-label="Anchor link for: wen-jian-jie-gou" class=zola-anchor href=#wen-jian-jie-gou>文件结构</a></h2><p>文件命名 <code>lower_snake_case.proto</code><p>所有文件应该以下列顺序排布：<ol><li>License header (if applicable)<li>File overview<li>Syntax<li>Package<li>Imports (sorted)<li>File options<li>Everything else</ol><h2 id=packages><a aria-label="Anchor link for: packages" class=zola-anchor href=#packages>Packages</a></h2><p>Packages 名称应该小写，还应该匹配文件层级。比如如果文件在 <code>my/package/</code>，package 名称应该为 <code>my.package</code><h2 id=message-he-field-names><a aria-label="Anchor link for: message-he-field-names" class=zola-anchor href=#message-he-field-names>Message 和 field names</a></h2><p>使用 CamelCase 命名 message -- 比如，<code>SongServerRequest</code>，使用 underscore_separated_names 命名 field name，比如 <code>song_name</code><pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>SongServerRequest </span><span>{
</span><span>  </span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>song_name </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>}
</span></code></pre><p>这种命名约定，语言生成为<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// cpp
</span><span style=color:#ff79c6>const</span><span> string</span><span style=color:#ff79c6>& </span><span style=color:#50fa7b>song_name</span><span>() </span><span style=color:#fff>{</span><span style=color:#ff79c6>...</span><span style=color:#fff>}
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>set_song_name</span><span>(</span><span style=color:#ff79c6>const</span><span> string</span><span style=color:#ff79c6>& </span><span style=font-style:italic;color:#ffb86c>x</span><span>) </span><span style=color:#fff>{</span><span style=color:#ff79c6>...</span><span style=color:#fff>}
</span></code></pre><pre class=language-java data-lang=java style=background:#282a36;color:#f8f8f2><code class=language-java data-lang=java><span style=color:#6272a4>// java
</span><span style=color:#ff79c6>public </span><span style=font-style:italic;color:#66d9ef>String </span><span style=color:#50fa7b>getSongName</span><span>() </span><span style=color:#fff>{</span><span style=color:#ff79c6>...</span><span style=color:#fff>}
</span><span style=color:#ff79c6>public </span><span style=font-style:italic;color:#66d9ef>Builder </span><span style=color:#50fa7b>setSongName</span><span>(</span><span style=font-style:italic;color:#66d9ef>String</span><span> v) </span><span style=color:#fff>{</span><span style=color:#ff79c6>...</span><span style=color:#fff>}
</span></code></pre><p>如果你的 field name 包含一个数字，不需要加下划线，比如应该是 <code>song_name1</code> 而不是 <code>song_name_1</code><h2 id=repeated-fields><a aria-label="Anchor link for: repeated-fields" class=zola-anchor href=#repeated-fields>Repeated fields</a></h2><p>使用复数命名这种 field<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>repeated string keys = 1;
</span><span>...
</span><span>repeated MyMessage accounts = 17;
</span></code></pre><h2 id=enums><a aria-label="Anchor link for: enums" class=zola-anchor href=#enums>Enums</a></h2><p>使用 CamelCase 命名 enum type name，使用 CPPITALS_WITH_UNDERSOCRES 命名 value name<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>enum </span><span>FooBar {
</span><span>  </span><span style=color:#bd93f9>FOO_BAR_UNSPECIFIED </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>0</span><span>;
</span><span>  </span><span style=color:#bd93f9>FOO_BAR_FIRST_VALUE </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>  </span><span style=color:#bd93f9>FOO_BAR_SECOND_VALUE </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>}
</span></code></pre><p>每个 enum 应该以分号结尾而不是逗号。需要为 enum 值添加前缀，因为历史代码的兼容，没有引入 C++11 的 enum class scope，零 enum 值应该有后缀<h2 id=services><a aria-label="Anchor link for: services" class=zola-anchor href=#services>Services</a></h2><p>如果你的 .proto 文件定义 RPC 服务，应该使用 CamelCase 风格，同时应用于服务名和任何RPC方法名<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>service </span><span style=text-decoration:underline;color:#8be9fd>FooService </span><span>{
</span><span>  </span><span style=font-style:italic;color:#8be9fd>rpc </span><span style=color:#50fa7b>GetSomething</span><span>(</span><span style=color:#8be9fd>FooRequest</span><span>) </span><span style=color:#ff79c6>returns </span><span>(</span><span style=color:#8be9fd>FooResponse</span><span>);
</span><span>}
</span></code></pre><h2 id=things-to-avoid><a aria-label="Anchor link for: things-to-avoid" class=zola-anchor href=#things-to-avoid>Things to avoid</a></h2><ul><li>只有 proto2 存在 required field<li>只有 proto2 存在 Groups</ul><h1 id=bian-ma><a aria-label="Anchor link for: bian-ma" class=zola-anchor href=#bian-ma>编码</a></h1><p><a href=https://developers.google.com/protocol-buffers/docs/encoding>原文</a><p>这篇文档阐述了 protobuf 的 message 二进制编码的原理。你在应用中使用 pb 时不需要理解这个，但是知道这些可以更好地帮助你了解使用 pb 编码之后的消息大小<h2 id=a-simple-message><a aria-label="Anchor link for: a-simple-message" class=zola-anchor href=#a-simple-message>A simple Message</a></h2><p>来看下这个简单的 message 定义：<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Test1 </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>a </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>1</span><span>;
</span><span>}
</span></code></pre><p>应用中，你可以创建 <code>Test1</code> message 然后 <code>set a </code> 为 150，然后序列化这个 message 作为输出流。如果打印这个流，你可以看到三个字节的内容：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>08</span><span> 96 01
</span></code></pre><p>哇哦，如此小，这意味着什么？且慢慢往下读<h2 id=base-128-varints><a aria-label="Anchor link for: base-128-varints" class=zola-anchor href=#base-128-varints>Base 128 Varints</a></h2><p>为了理解简单的 protocol buffer 编码，首先你需要理解 <em><strong>varints</strong></em>，Varints 是一种使用一个或者更多字节序列化整数的方法，越小的数字使用越少的字节数。<p>除了最后一个字节外，varint 每个字节都有最高有效位（msb），这表明还有更多的字节在后面。这个字节的低 7 位为一组来存储数字的补码表示，<strong>最低有效组在前</strong>。<p>比如，这有一个数字 1，简单一个字节：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>0000</span><span> 0001 </span><span style=color:#6272a4># 1
</span></code></pre><p>300 就要复杂一些：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>1010</span><span> 1100 0000 0010 </span><span style=color:#6272a4># 300
</span></code></pre><p>你如何认出这是 300 呢，首先丢掉每个字节的最高有效位（只是表示是不是最后一个字节）<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>1010</span><span> 1100 0000 0010
</span><span style=color:#50fa7b>-</span><span style=color:#ff79c6>>
</span><span> </span><span style=color:#50fa7b>010</span><span> 1100  000 0010
</span></code></pre><p>然后以 7 位一组反向整个二进制序列，就像前面所述，varints 保存数字式，<strong>最小有效组在前</strong>，然后你可以按照补码的正常计算方式来计算数字（正数的补码就是直接转化的二进制）<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>000</span><span> 0010  010 1100
</span><span style=color:#50fa7b>→</span><span>  000 0010 ++ 010 1100
</span><span style=color:#50fa7b>→</span><span>  100101100
</span><span style=color:#50fa7b>→</span><span>  256 + 32 + 8 + 4 = 300
</span></code></pre><h2 id=message-structure><a aria-label="Anchor link for: message-structure" class=zola-anchor href=#message-structure>Message Structure</a></h2><p>如你所知，一个 pb message 就是一系列的 key-value 对，序列化为二进制后的 message 使用域号 (field number) 作为 key--每个字段的名称和声明的类型只能在解码端通过引用消息类型的定义来确定。<p>当 message 编码时，keys 和 values 被连接成字节流。当 message 解码时，解析器需要跳过不认识的域。这样的话，新的域才能在不影响老程序的情况下添加到 message 的后面。最终，编码后的 message 中每对 key-value 取决于两个值--<strong><code>.proto</code>文件中的域号（field number)，声明的类型（为了了解信息的字节长度）</strong>。在大多数的语言实现中，key 也被称为 tag。<p>有效的类型声明如下表：<table><thead><tr><th style=text-align:left>Type<th style=text-align:left>Meaning<th style=text-align:left>Used For<tbody><tr><td style=text-align:left>0<td style=text-align:left>Varint<td style=text-align:left>int32, int64, uint32, uint64, sint32, sint64, bool, enum<tr><td style=text-align:left>1<td style=text-align:left>64-bit<td style=text-align:left>fixed64, sfixed64, double<tr><td style=text-align:left>2<td style=text-align:left>Length-delimited<td style=text-align:left>string, bytes, embedded messages, packed repeated fields<tr><td style=text-align:left>3<td style=text-align:left>Start group<td style=text-align:left>groups (deprecated)<tr><td style=text-align:left>4<td style=text-align:left>End group<td style=text-align:left>groups (deprecated)<tr><td style=text-align:left>5<td style=text-align:left>32-bit<td style=text-align:left>fixed32, sfixed32, float</table><p>字节流里的每个 key 的 value 都是<code>(field_number << 3) | wire_type</code>这样组成，换句话说，最后三位存储声明类型<p>现在，让我们再次看那个简单的例子。你已经知道第一个第一个数字总是 varint key，这里就是<code>08</code>，或者丢掉最高标志位：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>000</span><span> 1000
</span></code></pre><p>你可以通过获取最后三位得到声明的类型（0），然后右移三位获得域号（1）。现在你知道了域号是 1，接下来的字节还是 varint。使用前面知道的解码知识，你可以看到后面两个字节存储了 150 这个值<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>96</span><span> 01 = 1001 0110  0000 0001
</span><span>       </span><span style=color:#50fa7b>→</span><span> 000 0001  ++  001 0110 (drop the msb and reverse the groups of 7 bits)
</span><span>       </span><span style=color:#50fa7b>→</span><span> 10010110
</span><span>       </span><span style=color:#50fa7b>→</span><span> 128 + 16 + 4 + 2 = 150
</span></code></pre><h2 id=more-value-types><a aria-label="Anchor link for: more-value-types" class=zola-anchor href=#more-value-types>More Value Types</a></h2><h3 id=signed-integers><a aria-label="Anchor link for: signed-integers" class=zola-anchor href=#signed-integers>Signed Integers</a></h3><p>如同在前面小节看到，所有的 pb 类型为 0 的都被编码为 varints。但是在有符号整形（sint32/sint64），和标准整形（int32/int64）之间如果编码负数存在巨大区别。如果使用标准整形编码负数，varints 的结果<em>总是是个字节长度</em>，实际上，它被看做一个非常大的无符号整数，如果使用有符号整形，varint 使用 ZigZag 编码方式，这更有效率。<p>ZigZag 编码将有符号整数映射为无符号整数，使得具有较小绝对值的数字（比如-1）也具有较短的 varint 编码值。正是通过正数和负数"zig-zags"的方式，使得 -1 被编码为 1， 1 被编码为 2， -2 被编码为 3，以此类推，如同下面表格展示：<table><thead><tr><th style=text-align:left>Signed Original<th style=text-align:left>Encoded As<tbody><tr><td style=text-align:left>0<td style=text-align:left>0<tr><td style=text-align:left>-1<td style=text-align:left>1<tr><td style=text-align:left>1<td style=text-align:left>2<tr><td style=text-align:left>-2<td style=text-align:left>3<tr><td style=text-align:left>2147483647<td style=text-align:left>4294967294<tr><td style=text-align:left>-2147483648<td style=text-align:left>4294967295</table><p>换句话说，n 会这样编码：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span>(</span><span style=color:#50fa7b>n </span><span style=color:#ff79c6><< </span><span style=color:#bd93f9>1</span><span>) ^ (n </span><span style=color:#ff79c6>>> </span><span style=color:#bd93f9>31</span><span>)   </span><span style=color:#6272a4># for sint32
</span><span>(</span><span style=color:#50fa7b>n </span><span style=color:#ff79c6><< </span><span style=color:#bd93f9>1</span><span>) ^ (n </span><span style=color:#ff79c6>>> </span><span style=color:#bd93f9>63</span><span>)   </span><span style=color:#6272a4># for sint64
</span></code></pre><p>注意第二个位右移--<code>(n >> 31)</code>是算术移位的。换句话说，移位的结果不是全 0（n 为正数），就是全 1（n 为负数）。<p>当<code>sint32/sint64</code>被解析时，其值将解码回原始的带符号版本。<h3 id=non-varint-number><a aria-label="Anchor link for: non-varint-number" class=zola-anchor href=#non-varint-number>Non-Varint Number</a></h3><p>非 varint 数字类型就简单的两种<code>double 和 fixed64</code>，域类型为 1，告诉解析器是一个固定的 64 位的数据块；类似的<code>float 和 fixed32</code>，域类型为 5，告诉解析器固定为 32 位。这两种情况都被存储为小端字节序。<h3 id=strings><a aria-label="Anchor link for: strings" class=zola-anchor href=#strings>Strings</a></h3><p>域类型 2（长度受限）表示该值是 varint 编码的长度，后面跟着指定长度的字节。<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Test2 </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional </span><span style=font-style:italic;color:#66d9ef>string </span><span style=color:#fff>b </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>2</span><span>;
</span><span>}
</span></code></pre><p>设置值为"testing"编码为：（TLV）<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>12</span><span> 07 74 65 73 74 69 6e 67
</span></code></pre><p>这是"testing"的 UTF-8。key 是 0x12 -><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>0001</span><span> 0010 
</span><span style=color:#50fa7b>-</span><span style=color:#ff79c6>> </span><span style=color:#bd93f9>00010</span><span> 010
</span></code></pre><p>得到 field_number = 2，wire_type = 2。varint 的中的值长度为 7，lo 且为 0，我们在其后找到七个字节---我们的字符串。<h2 id=embedded-messages><a aria-label="Anchor link for: embedded-messages" class=zola-anchor href=#embedded-messages>Embedded Messages</a></h2><p>有一个 message 定义中包含了之前的 Test1：<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Test3 </span><span>{
</span><span>	</span><span style=color:#ff79c6>optional </span><span style=color:#8be9fd>Test1 </span><span style=color:#fff>c </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>3</span><span>;
</span><span>}
</span></code></pre><p>这是将 Test1 的 a 设置为 150 的编码版本：<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>1a</span><span> 03 08 96 01
</span></code></pre><p>正如你所看到的，最后三个字节跟我们第一个例子中一样（<code>08 96 01</code>），在数字 3 后面 - 内嵌的 message 跟 strings 的方式是一样的。<h2 id=optional-and-repeated-elements><a aria-label="Anchor link for: optional-and-repeated-elements" class=zola-anchor href=#optional-and-repeated-elements>Optional and Repeated Elements</a></h2><p>如果 proto2 的 message 定义中有<code>repeated</code>类型元素（没有包含参数<code>[packed=true]</code>），编码后的 message 具有零个或者多个具有相同字段编号的 key-value 对。这些重复的值不必要连续，可能跟其他域交叉出现。解析时，元素之间的顺序会保留下来，尽管其他字段的顺序会丢失。在 proto3 中，<code>repeated</code>声明使用<code>packed encoding</code>（下面的 packed repeated fields 节阐述）。<p>对于任意 proto3 非<code>repeated</code>域，和 proto2 中的<code>optional</code>域，编码后的 message 可能有也可能没有该字段编号的 key-value 对。<p>通常，编码后的 message 不会有一个以上非<code>repeated</code>域。但是解析器必须能够处理这种情况。对于数字和字符串类型，如果同一个域出现了多次，解析器取最后一个值。对于内嵌的 message 域，解析器合并同一个域的多个实例，就像使用<code>Message::MergeFrom</code>方法，表现为所有的奇异域都会被后面的实例替代，奇异内嵌 message 都会被递归式合并，<code>repeated</code>域会被串联起来。这些规则的结果就是，解码两个串联起来的编码 message 提供了解码两条 message 得到相同的结果，例如：<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>MyMessage message;
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ParseFromString</span><span>(str1 </span><span style=color:#ff79c6>+</span><span> str2);
</span></code></pre><p>// 等于下面的<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>MyMessage message, message2;
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ParseFromString</span><span>(str1);
</span><span>message2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ParseFromString</span><span>(str2);
</span><span>message</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>MergeFrom</span><span>(message2);
</span></code></pre><p>这个特性非常有用，允许你合并两条你不知道类型的 message。<h3 id=packed-repeated-fields><a aria-label="Anchor link for: packed-repeated-fields" class=zola-anchor href=#packed-repeated-fields>Packed Repeated Fields</a></h3><p>版本 2.1.0 引入了<code>packed repeated field</code>，在 proto2 中声明为<code>repeated</code>域而且具有<code>[packed=ture]</code>参数的，在 proto3 中，<code>repeated</code>默认使用 packed 打包标量数字类型。这些功能类似<code>repeated fields</code>，但是编码方式不同。<code>packed repeated field</code>包含 0 的元素不会出现在编码后的 message 中。另外，该域的所有元素都打包成域类型为 2 的单个 key-value 对。每个元素的编码方式与之前相同，除了在前面没有 key。<p>比如说，假设有一个 message type：<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span style=font-style:italic;color:#8be9fd>message </span><span style=text-decoration:underline;color:#8be9fd>Test4 </span><span>{	
</span><span>  </span><span style=color:#ff79c6>repeated </span><span style=font-style:italic;color:#66d9ef>int32 </span><span style=color:#fff>d </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>4 </span><span>[</span><span style=color:#8be9fd>packed </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>true</span><span>];
</span><span>}
</span></code></pre><p>让我们现在构造一个 Test4，提供 field d 的值为 3270 和 86942。然后编码后的形式如下：<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#bd93f9>22        </span><span style=color:#6272a4>// key (field number 4, wire type 2)
</span><span style=color:#bd93f9>06        </span><span style=color:#6272a4>// payload size (6 bytes)
</span><span style=color:#bd93f9>03        </span><span style=color:#6272a4>// first element (varint 3)
</span><span style=color:#bd93f9>8</span><span style=font-style:italic;color:#8be9fd>E </span><span style=color:#bd93f9>02     </span><span style=color:#6272a4>// second element (varint 270)
</span><span style=color:#bd93f9>9</span><span style=font-style:italic;color:#8be9fd>E</span><span> A7 </span><span style=color:#bd93f9>05  </span><span style=color:#6272a4>// third element (varint 86942)
</span></code></pre><p>只有<code>repeated</code>的数字类型（使用 varint，32/64 位的 wire-type）会被打包编码。<p>值得注意的是尽管没有理由为一个<code>repeated field</code>编码超多一个 key-value 对，编码器必须能够接受多个 key-value 对。这种情况下，payload 应该串联起来。每个对必须包含一整个元素。<p>pb 解析器必须能够解析通过<code>packed</code>编码的<code>repeated</code>域，就好像没有使用<code>packed</code>一样，反之亦然。这才能使得有没有加<code>[packed = true]</code>的前后兼容的方式添加新字段。<h2 id=field-order><a aria-label="Anchor link for: field-order" class=zola-anchor href=#field-order>Field Order</a></h2><p>域号（Field Number）可以在<code>.proto</code>文件中以任何顺序使用。顺序的选择不会影响 message 的序列化。<p>当 message 序列化时，对于如何写入已知或者未知域没有顺序保证。序列化顺序是一个实现细节，将来任何实现的细节可能都会改变。因此 protobuf 的解析器必须能够解析任意顺序域的编码。<h3 id=implications-han-yi><a aria-label="Anchor link for: implications-han-yi" class=zola-anchor href=#implications-han-yi>Implications 含义</a></h3><ul><li><p>不要假定序列化之后的 message 字节输出是稳定的，对于那些表示其他 pb 序列化消息的传递性字节域尤其是。</p><li><p>默认情况下，在同一个 pb message 实例上多次调用序列化方法可能会得到不同的输出；即，默认序列化输出是不确定性的</p> <ul><li>确定性序列化只能保证相同的二进制字节序列。字节输出可能在不通的版本之间有变化</ul><li><p>下列检查对于 pb message 实例 foo 可能是失败的：</p> <ul><li><code>foo.SerializeAsString() == foo.SerializeAsString()</code><li><code>Hash(foo.SerializeAsString()) == Hash(foo.SerializeAsString())</code><li><code>CRC(foo.SerializeAsString()) == CRC(foo.SerializeAsString())</code><li><code>FingerPrint(foo.SerializeAsString()) == FingerPrint(foo.SerializeAsString())</code></ul><li><p>有一些逻辑等效的 pb message 实例<code>foo</code>和<code>bar</code>可能序列化输出不同的场景：</p> <ul><li><code>bar</code>被老服务器序列化表示有些域是未知的<li><code>bar</code>被序列化时是不同语言实现的导致序列化域号顺序不同<li><code>bar</code>存在不确定性序列化的域<li><code>bar</code>有一个域，用于存储 pb message 的序列化字节输出，该 message 的序列化输出不同<li><code>bar</code>使用新的服务器序列化，实现不通导致输出不同<li><code>foo</code>和<code>bar</code>被单独的 message 以不通顺序串联起来</ul></ul><hr><h1 id=xu-lie-hua-yuan-li><a aria-label="Anchor link for: xu-lie-hua-yuan-li" class=zola-anchor href=#xu-lie-hua-yuan-li>序列化原理</a></h1><p>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式<p>protobuf2 中修饰符：<ul><li>required : 不可以增加或删除的字段，必须初始化；<li>optional : 可选字段，可删除，可以不初始化；<li>repeated : 可重复字段， 对应到 java 文件里，生成的是 List。</ul><h2 id=protobuf-de-shi-yong><a aria-label="Anchor link for: protobuf-de-shi-yong" class=zola-anchor href=#protobuf-de-shi-yong>protobuf 的使用</a></h2><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>protoc</span><span style=font-style:italic;color:#ffb86c> -I</span><span style=color:#ff79c6>=</span><span>SRC_DIR</span><span style=font-style:italic;color:#ffb86c> --cpp_out</span><span style=color:#ff79c6>=</span><span>DST_DIR person.proto
</span></code></pre><h2 id=bian-ma-yuan-li-zhong-dian-shi-lei-xing-he-yu-hao><a aria-label="Anchor link for: bian-ma-yuan-li-zhong-dian-shi-lei-xing-he-yu-hao" class=zola-anchor href=#bian-ma-yuan-li-zhong-dian-shi-lei-xing-he-yu-hao>编码原理（重点是类型和域号）</a></h2><p>protobuf 中的 message 中有很多字段，每个字段的格式：<pre class=language-proto data-lang=proto style=background:#282a36;color:#f8f8f2><code class=language-proto data-lang=proto><span>修饰符 字段类型 字段名 = 域号；
</span></code></pre><p>在序列化时，protobuf 按照<code>TLV</code>的格式序列化每一个字段，T 即 Tag，L 是 value 的长度, V 是该字段对应的 value，。如果字段是一个整形，L 部分会省略。<p>序列化后的 Value 按照原样保存在字符串或者文件中，Tag 按照一定转换条件保存起来，序列化之后的结果就是：TagValueTagValue...<p>Tag 的格式化序列是按照 message 中字段后面的域号和字段类型类转换的，转换公式为：<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>(field_number </span><span style=color:#ff79c6><< </span><span style=color:#bd93f9>3</span><span>) </span><span style=color:#ff79c6>|</span><span> write_type
</span></code></pre><table><thead><tr><th>wire_type<th>meaning<th>type<tbody><tr><td>0<td>Vaint<td>int32、int64、uint32、uint64、sint32、sint64、bool、enum<tr><td>1<td>64-bit<td>fixed、sfixed64、double<tr><td>2<td>Length-delimi<td>string、bytes、embedded、messages、packed repeated fields<tr><td>3<td>Start group<td>Groups(deprecated)<tr><td>4<td>End group<td>Groups(deprecated)<tr><td>5<td>32-bit<td>fixed32、sfixed32、float</table><p>protobuf 协议使用二进制格式表示 Tag 字段；对 value 而言，不同的类型采用的编码方式也不同，如果是整型，采用二进制表示；如果是字符，会直接原样写入文件或者字符串（即不编码）。<h1 id=cap-n-proto><a aria-label="Anchor link for: cap-n-proto" class=zola-anchor href=#cap-n-proto>cap'n proto</a></h1><p><a href=https://capnproto.org/index.html>官网</a><h1 id=cpp-serializers-dui-bi-benchmark><a aria-label="Anchor link for: cpp-serializers-dui-bi-benchmark" class=zola-anchor href=#cpp-serializers-dui-bi-benchmark>cpp-serializers 对比 benchmark</a></h1><p><a href=https://github.com/thekvs/cpp-serializers>github</a><h1 id=geng-xin-ji-lu><a aria-label="Anchor link for: geng-xin-ji-lu" class=zola-anchor href=#geng-xin-ji-lu>更新记录</a></h1><p>2021-05-07 init 翻译 protobuffer 官网 encode 的文档<p>2022-01-20 补充增加了 Options 和 custom options 部分</article></div></div></div><div id=gitalk-container></div><link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gitalk=new Gitalk({id:'protobuffer etc.',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script></div><script defer src=https://wendajiang.github.io/js/main.js></script><script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script><script defer src=https://wendajiang.github.io/search_index.en.js></script><script defer src=https://wendajiang.github.io/js/search.js></script>