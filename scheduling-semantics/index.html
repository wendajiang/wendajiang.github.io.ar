<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Scheduling semantics | 「靡不有初，鲜克有终」</title><meta content="blog of david" name=description><link href=https://wendajiang.github.io/scheduling-semantics/ rel=canonical><meta content="Scheduling semantics" property=og:title><meta content="blog of david" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/scheduling-semantics/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta content=2023-04-11T15:02:54 property=og:updated_time><meta content="Scheduling semantics" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/scheduling-semantics/"
      },
      "headline": "Scheduling semantics",
      "image": ,
      "datePublished": "2023-04-11T15:02:54",
      "dateModified": "2023-04-11T15:02:54",
      "author": {
        "@type": "Organization",
        "name": "Scheduling semantics"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Scheduling semantics",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "blog of david"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Scheduling Semantics",
            "item": "https://wendajiang.github.io/scheduling-semantics/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-1-general>4.1 General</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-2-execution-of-a-hardware-model-and-its-verification-environment>4.2 execution of a hardware model and its verification environment</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-3-event-simulation>4.3 Event Simulation</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-4-stratified-event-scheduler>4.4 Stratified event scheduler</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-5-systemverilog-simulation-reference-algorithm>4.5 SystemVerilog simulation reference algorithm</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-6-determinism>4.6 Determinism</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-7-nondeterminism>4.7 Nondeterminism</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-8-race-conditions>4.8 Race conditions</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-9-scheduling-implication-of-assignments>4.9 Scheduling implication of assignments</a><li><a href=https://wendajiang.github.io/scheduling-semantics/#4-10-pli-callback-control-points>4.10 PLI callback control points</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>Scheduling semantics</h1><p><small>Posted 2023-04-11 15:02:54 ‐ <strong>6 min read</strong></small><p><div class=category-area>「 <a href=https://wendajiang.github.io/tags/ieee1800> <div class=category>ieee1800</div> </a> 」</div></div><h1 id=4-1-general><a aria-label="Anchor link for: 4-1-general" class=zola-anchor href=#4-1-general>4.1 General</a></h1><ul><li>event-based simulation scheduling semantics<li>system verilog's stratified event scheduling algorithm<li>determinism and nondeterminism of event ordering<li>possible sources of race conditions<li>PLI callback control points</ul><h1 id=4-2-execution-of-a-hardware-model-and-its-verification-environment><a aria-label="Anchor link for: 4-2-execution-of-a-hardware-model-and-its-verification-environment" class=zola-anchor href=#4-2-execution-of-a-hardware-model-and-its-verification-environment>4.2 execution of a hardware model and its verification environment</a></h1><p>The elements that make up the System Verilog language can be used to describe the behavior, at varying levels of abstraction, of electronic hardware. System Verilog is a parallel programming language. The execution of certain language constructs is defined by parallel execution of blocks or processes. It is important to understand what execution order is guaranteed to the user and what execution order is indeterminate.<h1 id=4-3-event-simulation><a aria-label="Anchor link for: 4-3-event-simulation" class=zola-anchor href=#4-3-event-simulation>4.3 Event Simulation</a></h1><p>SV 语言是离散事件执行模型。根据定义，各个厂商实现的模拟器用户侧行为一致即可，具体实现使用什么算法是自由的。<p>SV 描述了相连接的执行线程或者 process。process 就是执行对象，有状态，将输入与输出关联起来。process 是并发调度元素，比如 <code>initial</code> 块。process 包括但不限于 <code>initial, always, always_comb, always_latch, always_ff</code> 块，primitives, continuous assignments; asynchonous tasks; procedural assignment statements.<p>net 或者 variable 状态的改变都被认为是 update event。<p>process 对于 update event 是敏感的。当 update event 发出，所有相关 process 以一定的顺序 evaluation。 evaluation of process 也是 event，<em>evaluation event</em>.<p>evaluation event 也包括 PLI callback<p>为了完整支持清晰可预测的交互，一个 time slot 被分为多个区域从而 event 可以被调度为特定顺序执行。这样也可以 properties 和 checkers 让 dut 在一个稳定状态采样。property expression 可以安全计算，tb 也可以没有延时执行，所有这些在可预测的行为中。这个机制也可以支持设计中的非零延时，clock propagation，以及 cyclu-accurate descriptions 的响应。<h1 id=4-4-stratified-event-scheduler><a aria-label="Anchor link for: 4-4-stratified-event-scheduler" class=zola-anchor href=#4-4-stratified-event-scheduler>4.4 Stratified event scheduler</a></h1><p>遵守标准的仿真器应该构建随时可动态调度，执行，删除的一系列数据结构。数据结构通常使用时间排序的链表实现，这种数据结构也容易实现二次划分。<p>第一次划分是根据时间。每个事件有且仅有一个仿真执行时间。所有可调度的 event 在特定时间都处于一个 time slot。仿真将本 time slot 的 event 执行或者清理完毕后才移动到下一个 time slot。这个过程保证了仿真器时间上不会回退。<p>一个 time slot 分为，<strong>划分的目的是在 design 和 testbench code 之间提供可预测的交互</strong><ul><li>preponed<li>pre-active<li>active<li>inactive<li>pre-NBA<li>NBA<li>post-NBA<li>pre-Observed<li>Observed<li>post-Observed<li>reactive<li>re-inactive<li>pre-re-NBA<li>re-NBA<li>post-re-NBA<li>pre-postponed<li>postponed</ul><p>可以分为 active region set 和 reactive region set。也可以分为 simulation region 和 PLI region。<p>PS. <em>NBA (nonblocking assignment update)</em><p><img alt=image-20230411163845834 src=https://wendajiang.github.io/pics/scheduling_semantics/image-20230411163845834.png><h1 id=4-5-systemverilog-simulation-reference-algorithm><a aria-label="Anchor link for: 4-5-systemverilog-simulation-reference-algorithm" class=zola-anchor href=#4-5-systemverilog-simulation-reference-algorithm>4.5 SystemVerilog simulation reference algorithm</a></h1><pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span>execute_simulation </span><span style=color:#fff>{
</span><span>  T </span><span style=color:#ff79c6>= </span><span style=color:#bd93f9>0</span><span>;
</span><span>  initialize the values of all nets </span><span style=color:#ff79c6>and</span><span> variables;
</span><span>  schedule all initialization events into time zero slot;
</span><span>  </span><span style=color:#ff79c6>while </span><span>(some time slot is nonempty) </span><span style=color:#fff>{
</span><span>    move to the first nonempty time slot </span><span style=color:#ff79c6>and</span><span> set T;
</span><span>    </span><span style=color:#50fa7b>execute_time_slot</span><span>(T);
</span><span>  </span><span style=color:#fff>}
</span><span style=color:#fff>}
</span><span>
</span><span>execute_time_slot </span><span style=color:#fff>{
</span><span>  </span><span style=color:#50fa7b>execute_region</span><span>(Preponed);
</span><span>  </span><span style=color:#50fa7b>execute_region</span><span>(Pre</span><span style=color:#ff79c6>-</span><span>Active);
</span><span>  </span><span style=color:#ff79c6>while</span><span>(any region in [Active </span><span style=color:#ff79c6>...</span><span> Pre</span><span style=color:#ff79c6>-</span><span>Postponed] is nonempty) </span><span style=color:#fff>{
</span><span>    </span><span style=color:#ff79c6>while</span><span>(any region in [Active </span><span style=color:#ff79c6>...</span><span> Post</span><span style=color:#ff79c6>-</span><span>Observed] is nonempty) </span><span style=color:#fff>{
</span><span>      </span><span style=color:#50fa7b>execute_region</span><span>(Active);
</span><span>      R </span><span style=color:#ff79c6>=</span><span> first nonempty region in [Active </span><span style=color:#ff79c6>...</span><span> Post</span><span style=color:#ff79c6>-</span><span>Observed];
</span><span>      </span><span style=color:#ff79c6>if </span><span>(R is nonempty) </span><span style=color:#fff>{
</span><span>        move events in R to the Active region;
</span><span>      </span><span style=color:#fff>}
</span><span>    </span><span style=color:#fff>} 
</span><span>    </span><span style=color:#ff79c6>while</span><span>(any resion in [Reactive </span><span style=color:#ff79c6>...</span><span> Post</span><span style=color:#ff79c6>-</span><span>Re</span><span style=color:#ff79c6>-</span><span>NBA] is nonempty) </span><span style=color:#fff>{
</span><span>      </span><span style=color:#50fa7b>execute_region</span><span>(Reactive);
</span><span>      R </span><span style=color:#ff79c6>=</span><span> first nonempty region in [Reactive </span><span style=color:#ff79c6>...</span><span> Post</span><span style=color:#ff79c6>-</span><span>Re</span><span style=color:#ff79c6>-</span><span>NBA];
</span><span>      </span><span style=color:#ff79c6>if </span><span>(R is nonempty) </span><span style=color:#fff>{
</span><span>        move events in R to the Reactive region;
</span><span>      </span><span style=color:#fff>}
</span><span>    </span><span style=color:#fff>}
</span><span>    </span><span style=color:#ff79c6>if </span><span>(all regions in [Active </span><span style=color:#ff79c6>...</span><span> Post</span><span style=color:#ff79c6>-</span><span>Re</span><span style=color:#ff79c6>-</span><span>NBA] are empty) </span><span style=color:#fff>{
</span><span>      </span><span style=color:#50fa7b>execute_region</span><span>(Pre</span><span style=color:#ff79c6>-</span><span>PostPoned);
</span><span>    </span><span style=color:#fff>}
</span><span>    </span><span style=color:#50fa7b>execute_region</span><span>(PostPoned);
</span><span>  </span><span style=color:#fff>}
</span><span style=color:#fff>}
</span><span>
</span><span>execute_region </span><span style=color:#fff>{
</span><span>  </span><span style=color:#ff79c6>while</span><span>(region is nonempty) </span><span style=color:#fff>{
</span><span>    E </span><span style=color:#ff79c6>=</span><span> any event from region;
</span><span>    remove E from the region;
</span><span>    </span><span style=color:#ff79c6>if </span><span>(E is an update event) </span><span style=color:#fff>{
</span><span>      update the modified object;
</span><span>      schedule evaluation event </span><span style=color:#ff79c6>for</span><span> any process sensitive to the object;
</span><span>    </span><span style=color:#fff>} </span><span style=color:#ff79c6>else </span><span style=color:#fff>{ </span><span style=color:#6272a4>// E is an evaluation event
</span><span>      evaluate the process associated with the event </span><span style=color:#ff79c6>and</span><span> possibly schedule further events </span><span style=color:#ff79c6>for</span><span> execution;
</span><span>    </span><span style=color:#fff>}
</span><span>  </span><span style=color:#fff>}
</span><span style=color:#fff>}
</span></code></pre><h1 id=4-6-determinism><a aria-label="Anchor link for: 4-6-determinism" class=zola-anchor href=#4-6-determinism>4.6 Determinism</a></h1><p>标准保证了这样的顺序：<ol><li>在 begin-end 块中的 stmt 应该按序执行。begin-end 块中的 stmt 可以按需挂起（支持其他 process）<li>NBA 应该按序执行</ol><h1 id=4-7-nondeterminism><a aria-label="Anchor link for: 4-7-nondeterminism" class=zola-anchor href=#4-7-nondeterminism>4.7 Nondeterminism</a></h1><p>不确定性来源<ol><li>active events 可以从 active 或者 reactive event 中取出执行<li>没有时间控制块不必作为一个 event 执行。在 procedural stmt 中执行任何时候仿真器可以允许 process 交错执行，这样就是不确定的并且不受用户控制</ol><h1 id=4-8-race-conditions><a aria-label="Anchor link for: 4-8-race-conditions" class=zola-anchor href=#4-8-race-conditions>4.8 Race conditions</a></h1><pre class=language-verilog data-lang=verilog style=background:#282a36;color:#f8f8f2><code class=language-verilog data-lang=verilog><span>assign p = q;
</span><span>initial begin
</span><span>  q = 1;
</span><span>  #1 q = 0;
</span><span>  $display(p);
</span><span>end
</span></code></pre><p>输出1 0 都对。<h1 id=4-9-scheduling-implication-of-assignments><a aria-label="Anchor link for: 4-9-scheduling-implication-of-assignments" class=zola-anchor href=#4-9-scheduling-implication-of-assignments>4.9 Scheduling implication of assignments</a></h1><h1 id=4-10-pli-callback-control-points><a aria-label="Anchor link for: 4-10-pli-callback-control-points" class=zola-anchor href=#4-10-pli-callback-control-points>4.10 PLI callback control points</a></h1><p>两种 PLI cb：特定事件出现时执行；注册为 one-shot evaluation event<table><thead><tr><th>Callback<th>Event Region<tbody><tr><td>cbAfterDelay<td>Pre-Active<tr><td>cbNextSimTime<td>Pre-Active<tr><td>cbReadWriteSynch<td>Pre-NBA or Post-NBA<tr><td>cbAtStartOfSimTime<td>Pre-Active<tr><td>cbNBASynch<td>Pre-NBA<tr><td>CbAtEndOfSimTime<td>Pre-Postponed<tr><td>cbReadOnlySynch<td>PostPoned</table></article></div></div></div><div id=gitalk-container></div><link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gitalk=new Gitalk({id:'Scheduling semantics',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script></div><script defer src=https://wendajiang.github.io/js/main.js></script><script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script><script defer src=https://wendajiang.github.io/search_index.en.js></script><script defer src=https://wendajiang.github.io/js/search.js></script>