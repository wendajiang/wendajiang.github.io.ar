<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://wendajiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://wendajiang.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>shared library | 「靡不有初，鲜克有终」</title><meta content="blog of david" name=description><link href=https://wendajiang.github.io/shared-library/ rel=canonical><meta content="shared library" property=og:title><meta content="blog of david" property=og:description><meta content=article property=og:type><meta content=https://wendajiang.github.io/shared-library/ property=og:url><meta content=https://wendajiang.github.io/david.png property=og:image><meta content=2024-04-25T11:01:19 property=og:updated_time><meta content="shared library" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/shared-library/"
      },
      "headline": "shared library",
      "image": ,
      "datePublished": "2023-03-04T09:07:19",
      "dateModified": "2024-04-25T11:01:19",
      "author": {
        "@type": "Organization",
        "name": "shared library"
      },
      "publisher": {
        "@type": "Organization",
        "name": "shared library",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/david.png"
        }
        
      },
      "description": "blog of david"
    }
    </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wendajiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Shared Library",
            "item": "https://wendajiang.github.io/shared-library/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://wendajiang.github.io/david.png rel=apple-touch-icon sizes=180x180><link href=https://wendajiang.github.io/david.png rel=icon sizes=32x32 type=image/png><link href=https://wendajiang.github.io/david.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://wendajiang.github.io/site.webmanifest rel=manifest><link href=https://wendajiang.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script>function initMermaid(){var a={startOnLoad:true,theme:"neutral",flowchart:{useMaxWidth:true,htmlLabels:true}};mermaid.initialize(a);window.mermaid.init(undefined,document.querySelectorAll('.mermaid'))}</script><script async onload=initMermaid() src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://wendajiang.github.io>「靡不有初，鲜克有终」</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/wendajiang><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/books/effective-modern-cpp/>Books</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/turtle/>Turtle</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/essay/>Essay</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/QA/>Q&A</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/tags>Tags</a><li class=nav-item><a class=nav-link href=https://wendajiang.github.io/archive>Archive</a></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><nav aria-label="Secondary navigation" class="books-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://wendajiang.github.io/shared-library/#problem>problem</a></li><ul><li><a href=https://wendajiang.github.io/shared-library/#what-is-mean>What is mean?</a></ul><li><a href=https://wendajiang.github.io/shared-library/#how-to-resolve-it>How to resolve it?</a></li><ul><li><a href=https://wendajiang.github.io/shared-library/#first-should-find-why-it-happended-that-the-section-write-absulote-path>First should find why it happended that the section write absulote path</a><li><a href=https://wendajiang.github.io/shared-library/#the-underhood>The underhood</a><li><a href=https://wendajiang.github.io/shared-library/#solution>Solution</a></ul><li><a href=https://wendajiang.github.io/shared-library/#continuation>Continuation</a></li><ul><li><a href=https://wendajiang.github.io/shared-library/#bsymbolic-linker-option>-Bsymbolic linker option</a><li><a href=https://wendajiang.github.io/shared-library/#but-the-bsymbolic-maybe-cause-ugly-problem>But, the Bsymbolic maybe cause ugly problem</a></ul><li><a href=https://wendajiang.github.io/shared-library/#supplement-linkers-loaders>Supplement Linkers & Loaders</a></li><ul><li><a href=https://wendajiang.github.io/shared-library/#compiler-linker-and-loader-in-action>Compiler, Linker and Loader in Action</a><li><a href=https://wendajiang.github.io/shared-library/#linkers-vs-loaders>Linkers vs Loaders</a><li><a href=https://wendajiang.github.io/shared-library/#object-files>Object Files</a><li><a href=https://wendajiang.github.io/shared-library/#symbols-and-symbol-resolution>Symbols and symbol resolution</a></li><ul><li><a href=https://wendajiang.github.io/shared-library/#linking-with-static-libraries>Linking with static libraries</a></ul><li><a href=https://wendajiang.github.io/shared-library/#relocation>Relocation</a><li><a href=https://wendajiang.github.io/shared-library/#dynamic-linking-shared-libraries>Dynamic linking: Shared libraries</a><li><a href=https://wendajiang.github.io/shared-library/#loading-shared-libraries-from-applications>Loading shared libraries from applications</a><li><a href=https://wendajiang.github.io/shared-library/#tools-for-manipulating-object-files>Tools for manipulating object files</a></ul><li><a href=https://wendajiang.github.io/shared-library/#executable-shared-library>executable shared-library</a><li><a href=https://wendajiang.github.io/shared-library/#reference>reference</a></ul></nav></div></nav><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>shared library</h1><p><small>Posted 2023-03-04 09:07:19 ‐ <strong>14 min read</strong></small><p><div class=category-area>「 <a href=https://wendajiang.github.io/tags/so> <div class=category>so</div> </a><a href=https://wendajiang.github.io/tags/link> <div class=category>link</div> </a> 」</div></div><p>update at 2023-06-15<p>update at 2023-07-27<h1 id=problem><a aria-label="Anchor link for: problem" class=zola-anchor href=#problem>problem</a></h1><p>In one scenoria, I find this:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>></span><span> ldd </span><span style=color:#50fa7b>main
</span><span style=color:#ff79c6>></span><span>    libstdc++.so.6 </span><span style=color:#ff79c6>=></span><span> /lib64/libstdc++.so.6 (</span><span style=color:#50fa7b>0x00007ffff7828000</span><span>)
</span><span>     </span><span style=color:#50fa7b>...
</span><span>     </span><span style=color:#50fa7b>/home/david/foo.so</span><span> (0xxxxx)
</span><span>     </span><span style=color:#50fa7b>/lib64/ld-linux-x86-64.so.2</span><span> (0x00007ffff7dd4000)
</span></code></pre><p>And if the /home/david/foo.so do not exist, I try to set LD_LIBRARY_PATH, change the rpath, and all not work. Why?<h2 id=what-is-mean><a aria-label="Anchor link for: what-is-mean" class=zola-anchor href=#what-is-mean>What is mean?</a></h2><p>In the ELF execute file format, the dynamic library record the [NEEDED] section, and when [NEEDED] secion has no <code>/</code> slash, the library directory resolve at run-time, and the rules order is<ul><li>rpath<li>LD_LIBRARY_PATH environment<li>runpath<li>/etc/ld.so.cache checked to see if it contains an entry for the library<li>/lib or /usr/lib</ul><p>But if the [NEEDED] section has / slash, the execute do not search by above rules, and directly use the path dynamic library.<p>We should note, -Wl,-rpath=some/path <a href=http://xahlee.info/UnixResource_dir/_/ldpath.html>Why LD_LIBRARY_PATH is bad</a><h1 id=how-to-resolve-it><a aria-label="Anchor link for: how-to-resolve-it" class=zola-anchor href=#how-to-resolve-it>How to resolve it?</a></h1><h2 id=first-should-find-why-it-happended-that-the-section-write-absulote-path><a aria-label="Anchor link for: first-should-find-why-it-happended-that-the-section-write-absulote-path" class=zola-anchor href=#first-should-find-why-it-happended-that-the-section-write-absulote-path>First should find why it happended that the section write absulote path</a></h2><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>></span><span> gcc </span><span style=color:#50fa7b>-o</span><span> main /home/david/foo.so
</span></code></pre><p>This command cause it. However, I try this<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>></span><span> gcc </span><span style=color:#50fa7b>-o</span><span> main /home/david/foo.so /lib64/libstdc++.so.6
</span></code></pre><p>The libstdc++.so.6 is still the name and need to be searched at runtime, Why?<h2 id=the-underhood><a aria-label="Anchor link for: the-underhood" class=zola-anchor href=#the-underhood>The underhood</a></h2><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>></span><span> man </span><span style=color:#50fa7b>ld
</span></code></pre><p>I find the -soname option, it's decribed as below:<blockquote><p>When creating and ELF shared object, set the internal DT_SONAME field to the specified name. When an executable is linked with a shared object which has a DT_SONAME field, then when the executable is run the dynamic linker will attempt to load hte shared object specified by the DT_SOMANE field rather than the using the file name given to the linker.</blockquote><h2 id=solution><a aria-label="Anchor link for: solution" class=zola-anchor href=#solution>Solution</a></h2><p>So, I can create the foo.so by<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>></span><span> gcc </span><span style=color:#50fa7b>-shared</span><span style=font-style:italic;color:#ffb86c> -Wl</span><span>,-soname,libfoo.so foo.cc</span><span style=font-style:italic;color:#ffb86c> -o</span><span> libfoo.so
</span></code></pre><p>And, the main executable [NEEDED] section will be the libfoo.so name rather than the absolute path.<hr><h1 id=continuation><a aria-label="Anchor link for: continuation" class=zola-anchor href=#continuation>Continuation</a></h1><h2 id=bsymbolic-linker-option><a aria-label="Anchor link for: bsymbolic-linker-option" class=zola-anchor href=#bsymbolic-linker-option>-Bsymbolic linker option</a></h2><p>After learning the soname, I read the <code>Bsymbolic</code> linker option in the tlpi book 41.12[Run-Time Symbol Resolution].<pre class=language-cpp data-lang=cpp style=background:#282a36;color:#f8f8f2><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// prog
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>xyz</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#8be9fd>printf</span><span>(</span><span style=color:#f1fa8c>"main-xyz</span><span style=color:#ff79c6>\n</span><span style=color:#f1fa8c>"</span><span>);
</span><span style=color:#fff>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>main</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#50fa7b>func</span><span>();
</span><span style=color:#fff>}
</span><span>
</span><span style=color:#6272a4>// libfoo.so
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>xyz</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#8be9fd>printf</span><span>(</span><span style=color:#f1fa8c>"foo-xyz</span><span style=color:#ff79c6>\n</span><span style=color:#f1fa8c>"</span><span>);
</span><span style=color:#fff>}
</span><span>
</span><span style=font-style:italic;color:#8be9fd>void </span><span style=color:#50fa7b>func</span><span>() </span><span style=color:#fff>{
</span><span>  </span><span style=color:#50fa7b>xyz</span><span>();
</span><span style=color:#fff>}
</span></code></pre><p>What's happened? It print <code>main-xzy</code>.<ul><li>A definition of a global symbol in the main program overrides a definition in a library.<li>If a global symbol is defined in multiple libraries, then a reference to that symbol is bound to the first definition found by scanning libraries in the left-to-right order in which they were listed on the static link command line.</ul><p>These semantics make the transition from static to shared libraries relatively strightforward. But the most significant problem is that these semantics conflict with the model of a shared library as implementing a self-contained subsystem. By default, a shared library can't guarantee that a reference to one of its own glboal symbols will actually be bound to the library's definition of that symbol.<p>In the above scenario, if we wanted to ensure that the invocation of <code>xyz()</code> in the shared library actually called the version of the function defined within the library, then we could use the <code>-Bsymbolic</code> linker option when building the shared library.<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>man</span><span> ld
</span></code></pre><blockquote><p>-Bsymbolic<p>When creating a shared library, bind references to global symbols to the definition within the shared library, if any. Normmally, it is possible for a program linked against a shared library to override the definition within the shared library. This option can also be used with the --export-dynamic option, when creating a position independent executable, to bind references to global symbols to the definition within the executable. This option is only meaningful on ELF paltforms which support shared libraries and position independent executables.</blockquote><h2 id=but-the-bsymbolic-maybe-cause-ugly-problem><a aria-label="Anchor link for: but-the-bsymbolic-maybe-cause-ugly-problem" class=zola-anchor href=#but-the-bsymbolic-maybe-cause-ugly-problem>But, the Bsymbolic maybe cause ugly problem</a></h2><p>Oppus, I learn it first, and want to using it for my shared library. And the option conflict with <a href=https://wendajiang.github.io/testing-framework/>doctest</a> using.<p>I deep learn it and find if using singleton, it's expected behavior is if main and shared-library using the one single instance, the <code>-Bsymbolic</code> option destroy it.<p>So the <code>-Bsymbolic</code> using scenoria is the shared-library is self-contained model.<p>the reference https://maskray.me/blog/2021-05-16-elf-interposition-and-bsymbolic explain the reason (pointer equality) and https://flameeyes.blog/2012/10/07/symbolism-and-elf-files-or-what-does-bsymbolic-do/<h1 id=supplement-linkers-loaders><a aria-label="Anchor link for: supplement-linkers-loaders" class=zola-anchor href=#supplement-linkers-loaders><a href=https://www.linuxjournal.com/article/6463>Supplement</a> Linkers & Loaders</a></h1><p><em>Linking</em> is the process of combining various pieces of code and data together to form a single executable that can be loader in memory. Linking can be done at compile time, at load time(by loaders) and also at run time (by application programs).<h2 id=compiler-linker-and-loader-in-action><a aria-label="Anchor link for: compiler-linker-and-loader-in-action" class=zola-anchor href=#compiler-linker-and-loader-in-action>Compiler, Linker and Loader in Action</a></h2><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>cpp</span><span> other-command-line-options a.c /tmp/a.i </span><span style=color:#6272a4># preprocessor
</span><span style=color:#50fa7b>cc1</span><span> other-command-line-options /tmp/a.i</span><span style=font-style:italic;color:#ffb86c> -o</span><span> /tmp/a.s </span><span style=color:#6272a4># compiler proper
</span><span style=color:#50fa7b>as</span><span> other-command-line-options /tmp/a.s</span><span style=font-style:italic;color:#ffb86c> -o</span><span> /tmp/a.o </span><span style=color:#6272a4># assembler
</span><span style=color:#6272a4># repeat for file b.c
</span><span>
</span><span style=color:#50fa7b>ld</span><span> other-command-line-options /tmp/a.o /tmp/b.o</span><span style=font-style:italic;color:#ffb86c> -o</span><span> a.out
</span></code></pre><h2 id=linkers-vs-loaders><a aria-label="Anchor link for: linkers-vs-loaders" class=zola-anchor href=#linkers-vs-loaders>Linkers vs Loaders</a></h2><ul><li>Program Loading. This refers to copying a program image from hard disk to the main memory in order to put the program in ready-to-run state. In some cases, program loading also might invole allocating storage space or mapping virtual addresses to disk pages.<li>Relocation. Compilers and assemblers generate the object code for each input module with a starting address of zero. Relocation is the process of assigning load addresses to different parts of the program by merging all sections of the same type into one section. The code and data section also are adjusted so they point to the correct runtime addresses.<li>Symbol Resolution. A program is made up of multiple subprograms; reference of one subprogram to another is made through symbols. A linker's job to resolve the reference by noting the symbol's location and patching the caller's object code.</ul><p>So a condiderable overlap exists between the functions of linkers and loaders. One way of think of them is: the loader does the program loading; the linker does the symbol resolution; and either of them can do the relocation.<h2 id=object-files><a aria-label="Anchor link for: object-files" class=zola-anchor href=#object-files>Object Files</a></h2><ul><li>Relocatable object file, which contains binary code and data in a form that can be combined with other relocatable object files at compile time to create an executable object file.<li>Executable object file, which contains binary code and data in a form that can be directly loader into memory and executed.<li>Shared object file, which is a special type of relocatable object files that can be loaded into memory and linker dynamically, either at load time or at run time.</ul><p>ELF:<table><thead><tr><th>ELF Header<th>starts with a 4-byte magic string \177ELF<tbody><tr><td>.text<td>the machine code of the compiled program<tr><td>.rodata<td>Read-only data, such as the format strings in printf stmt<tr><td>.data<td>initialized global variables<tr><td>.bss<td>uninitialized global varitables. BSS stands for block storage start, and this section actually occupies no space in the object file; it is merely a placer holder<tr><td>.symtab<td>a symbol table with information about functions and global variables defined and referenced in the program. This table does not contain any entries for local variables; those are maintained on the stack<tr><td>.rel.text<td>a list of locations in the .text section that need to be modified when the linker combines this object file with other object files<tr><td>.rel.data<td>relocation information for global variables referenced but not defined in the current module<tr><td>.debug<td>a debugging symbol table with entries for local and global variables. This section is present only if the compiler is invoked with -g option<tr><td>.line<td>a mapping between line numbers in the original C source program and machine code instructions in the .text section. This information is required by debugger programs<tr><td>.strtab<td>a string table for the symbol tables in the .symtab and .debug sections</table><h2 id=symbols-and-symbol-resolution><a aria-label="Anchor link for: symbols-and-symbol-resolution" class=zola-anchor href=#symbols-and-symbol-resolution>Symbols and symbol resolution</a></h2><p>Every relocatable object file has a symbol table and associated symbols. In the context of a linker, the following kins of symbols are present:<ul><li>Global symbols defined by the module and referenced by other modules. All non-static functions and global varitables fall in this category<li>Global symbols referenced by the input module but defined elsewhere. All functions and variables with extern declaration fall in this category<li>Local symbols defined and referenced exlusively by the input module. All static functions and static variables fall here.</ul><p><strong>At compile time, the compilers exports each global symbol as either strong or weak. Functions and initialzed global variables get strong weight, while global uninitialized varaibles are weak.</strong><h3 id=linking-with-static-libraries><a aria-label="Anchor link for: linking-with-static-libraries" class=zola-anchor href=#linking-with-static-libraries>Linking with static libraries</a></h3><p>During the process of symbol resolution using static libraries, linkers scans the relocatable object files and archives from left to right as input on the command line. During this scan, linker maintains a set of O, relocatable object files that go into the executable; a set U, unresolved symbols; and a set of D, symbols defined in previous input modules. Initially, all three sets are empty.<ul><li>for each input argument on the command line, linkers determintes if input is an object files or an archive. If input is relocatable object file, linkers adds it to set O, updates U and D and proceeds to next input file.<li>if input is an archive, it scans through the list of member modules that constitute the archive to match any unresolved symbols present in U. If some archive member defines any unresolved symbol that archive member is added to the list O, and U and D are updated per symbols found in the archive member. This process is iterated for all member object files.<li>After all the input arguments are processed through the above two steps, if U is found be not empty, linker prints an error report and terminates. Otherwise, it merges and relocated the object files in O to build the ouput executable file.</ul><p>This also explains why static libraries are placed at the end of the linker command. <strong>Special care must be taken in cases of cyclic dependencies libraries.</strong> Input libraries must be ordered so each symbol is referenced by a member of an archive and at least one definition of a symbol is followed by a reference to it on the command line. Also, if an unresolved symbol is defined in more than one static library moduels, the definition is picked from the first library found in the command line.<h2 id=relocation><a aria-label="Anchor link for: relocation" class=zola-anchor href=#relocation>Relocation</a></h2><p>Once the linker has resolved all the symbols, each symbol reference has exactly one definition. At this point, linker starts the process of relocation, which involves the following two steps:<ul><li>Relocaing sections and symbol definitions. Linker merges all the sections of the same type into a new single section. The linker then assigns runtime memory addresses to new aggregate sections, to each section defined by the input module and also to each symbol. After the completion of this step, every instruction and global variable in the program has a unique loadtime address<li>Relocating symbolo reference within sections. In this step, linker modifies every symbol reference in the code and data sections so they point to the correct loadtime addresses.</ul><p>Whenever assembler encounters an unresolved symbol, it generates a relocation entry for that object and places it in the .relo.text/.relo.data sections. A relocation entry contains information about how to resolve the reference. A typical ELF relocation entry contains the following members:<ul><li>Offset, a section offset of the reference that needs to be relocated. For a relocatable file, this value is the byte offset from the beginning of the section to the storage unit affected by relocation.<li>Symbol, a symbol the modified reference should point to. It is the symbol table index with respect to which the relocation must be made.<li>Type, the relocation type, normally R_386_PC32, that signifies PC-relative addressing. R_386_32 signifies absolute addressing.</ul><p>The linker iterates over all the relocation entries present in the relocatable object modules and relocates the unresolved symbols depending on the type. For R_386_PC32, the relocating address is calculated as S + A - P; for R_386_32 type, the address is calculated as S + A. In these calculations, S denotes the value of the symbol from the relocation entry, P denotes the section offset or address of the storage unit being relocated (computed using the value of offset from relocation entry) and A is the address needed to compute the value of the relocatable field.<h2 id=dynamic-linking-shared-libraries><a aria-label="Anchor link for: dynamic-linking-shared-libraries" class=zola-anchor href=#dynamic-linking-shared-libraries>Dynamic linking: Shared libraries</a></h2><p>A shared library is an object module that can be loaded at run time at an arbitrary memory address, and it can be linked to by a program in memory.<p>-fPIC option tells the compiler to generate position independent code (PIC)<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>gcc</span><span style=font-style:italic;color:#ffb86c> -shared -fPIC -o</span><span> libfoo.so a.o b.o
</span><span style=color:#50fa7b>gcc</span><span> bar.o ./libfoo.so
</span></code></pre><p>The executable simply contains some relocation and symbol table information that allow references to code and data in libfoo.so to be resolved at run time. Thus, a.out here is a partially executable file that still has its dependency in libfoo.so. The executable also contains a .interp section that contains the name of the dynamic linker, which itself is a shared object on Linux systems (ld-linux.so). So, when the executable is loaded into memory, the loader passes control to the dynamic linker. The dynamic linker contains some start-up code that maps the shared libraries to the program's address space. It then does the following:<ul><li>relocates the text and data of libfoo.so into memory segment; and<li>relocateds any references in a.out to symbols defined by libfoo.so</ul><p>Finaly, the dynamic linker passes control to the application. From this point on, location of shared object is fixed in the memory.<h2 id=loading-shared-libraries-from-applications><a aria-label="Anchor link for: loading-shared-libraries-from-applications" class=zola-anchor href=#loading-shared-libraries-from-applications>Loading shared libraries from applications</a></h2><p>dlopen / dlsym / dlclose<h2 id=tools-for-manipulating-object-files><a aria-label="Anchor link for: tools-for-manipulating-object-files" class=zola-anchor href=#tools-for-manipulating-object-files>Tools for manipulating object files</a></h2><ul><li>ar: creates static libraries<li>objdump: this is the most important binary tool; it can be used to display all the information in an object binary file<li>strings: list all the printable strings in binary file<li>nm: lists the symbols defined in the symbol table of an object file<li>ldd: lists the shared libraries on which the object binary is dependent<li>strip: deletes the symbol table information</ul><h1 id=executable-shared-library><a aria-label="Anchor link for: executable-shared-library" class=zola-anchor href=#executable-shared-library>executable shared-library</a></h1><p>This <a href=http://www.rkoucha.fr/tech_corner/executable_lib.html>blog</a> describe in detail.<p><a href=https://stackoverflow.com/questions/1449987/building-a-so-that-is-also-an-executable/1451482#1451482>stackoverflow</a> introduct a more realistic example <a href=https://git.kernel.org/pub/scm/libs/libcap/libcap.git/tree/libcap/execable.h>pcap</a>.<h1 id=reference><a aria-label="Anchor link for: reference" class=zola-anchor href=#reference>reference</a></h1><ul><li>https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html<li><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>nm</span><span style=font-style:italic;color:#ffb86c> -g</span><span> main </span><span style=color:#ff79c6>| </span><span style=color:#50fa7b>rg</span><span> rpath
</span><span style=color:#50fa7b>readelf</span><span style=font-style:italic;color:#ffb86c> -p</span><span> man </span><span style=color:#ff79c6>| </span><span style=color:#50fa7b>rg</span><span style=font-style:italic;color:#ffb86c> -i</span><span> needed
</span><span style=color:#50fa7b>objdump</span><span style=font-style:italic;color:#ffb86c> -p</span><span> main </span><span style=color:#ff79c6>| </span><span style=color:#50fa7b>rg</span><span style=font-style:italic;color:#ffb86c> -i</span><span> needed
</span></code></pre><li>the rules order of runtime search dynamic library is tlpi book section 41.11<li>Another useful environment variable in the GNU C loader is LD_DEBUG. This triggers the dl* functions so that they give quite verbose information on what they are doing. For example:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#ff79c6>export </span><span style=color:#fff>LD_DEBUG</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>files
</span><span style=color:#50fa7b>command_to_run
</span></code></pre> displays the processing of files and libraries when handling libraries, telling you what dependencies are detected and which SOs are loaded in what order. Setting LD_DEBUG to <code>bindings</code> displays information about symbol binding, setting it to <code>libs</code> displays the library search paths, and setting it to <code>versions</code> displays the version depdendencies. Setting LD_DEBUG to <code>help</code> and then trying to run a program will list the possible options. Again, LD_DEBUG isn't intended for normal use, but it can be handy when debugging and testing.<li>https://zerol.me/2021/06/13/Linker-Symbol-Conflict/<li>https://maskray.me/blog/2021-05-16-elf-interposition-and-bsymbolic<li>https://flameeyes.blog/2012/10/07/symbolism-and-elf-files-or-what-does-bsymbolic-do/<li><a href=https://stackoverflow.com/questions/49138195/whats-the-difference-between-rpath-link-and-l>ldd and linker(ld) both use RPATH/RUNPATH to find the dependencies</a><li><a href=https://medium.com/obscure-system/rpath-vs-runpath-883029b17c45>rpath and runpath order and exploration</a></ul></article></div></div></div><div id=gitalk-container></div><link href=https://unpkg.com/gitalk/dist/gitalk.css rel=stylesheet><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gitalk=new Gitalk({id:'shared library',clientID:'a17500877ddbb2dd70b9',clientSecret:'77e1c5816e97e2473c0a617bd0e3ece99f33559f',repo:'wendajiang.github.io',owner:'wendajiang',admin:['wendajiang'],perPage:50});gitalk.render('gitalk-container')</script></div><script defer src=https://wendajiang.github.io/js/main.js></script><script defer src=https://wendajiang.github.io/plugins/elasticlunr.min.js></script><script defer src=https://wendajiang.github.io/search_index.en.js></script><script defer src=https://wendajiang.github.io/js/search.js></script>